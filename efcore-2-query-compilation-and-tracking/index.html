<!DOCTYPE html>
<html lang="en">

<head>

  <!-- Minima -->
  <!-- Hexo theme created by @adisaktijrs -->

  <!-- Basic Page Needs
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <meta charset="utf-8">

  
  <title>EFCoreæŸ¥ç¼ºè¡¥æ¼ï¼ˆäºŒï¼‰ï¼šæŸ¥è¯¢</title>
  
  <link rel="canonical" href="https://www.90yang.com/efcore-2-query-compilation-and-tracking/">
  
  <meta name="description" content="ç¬¬ 20 è½® TechEmpower è¯„æµ‹ç»“æœå‡ºç‚‰äº†ï¼ŒASP.NET Core çš„ Plaintext æˆç»©ååˆ—å‰èŒ…ï¼Œå¸¦ç€ EFCore çš„æµ‹è¯•å´åœ¨ Single query / Multiple queries / Fortunes ä¸­è½äº†ä¸‹é£ï¼Œæˆç»©è¿œä¸å¦‚ dapperï¼Œæ›´ä¸å¦‚ç›´æ¥ ado.net">
  
  
  <meta name="author" content="å°ç¾Š">
  <meta property="og:site_name" content="å°ç¾Šå„¿çš„å¿ƒæƒ…å¤©ç©º" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="EFCoreæŸ¥ç¼ºè¡¥æ¼ï¼ˆäºŒï¼‰ï¼šæŸ¥è¯¢" />
  
  <meta property="og:description" content="ç¬¬ 20 è½® TechEmpower è¯„æµ‹ç»“æœå‡ºç‚‰äº†ï¼ŒASP.NET Core çš„ Plaintext æˆç»©ååˆ—å‰èŒ…ï¼Œå¸¦ç€ EFCore çš„æµ‹è¯•å´åœ¨ Single query / Multiple queries / Fortunes ä¸­è½äº†ä¸‹é£ï¼Œæˆç»©è¿œä¸å¦‚ dapperï¼Œæ›´ä¸å¦‚ç›´æ¥ ado.net">
  
  <meta property="og:url" content="https://www.90yang.com/efcore-2-query-compilation-and-tracking/" />

  <!-- Mobile Specific Metas
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Preload fonts
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <link rel="preload" href="../fonts/dm-serif-display-v4-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="../fonts/inter-v2-latin-regular.woff2" as="font" type="font/woff2" crossorigin>

  <!-- CSS
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  
<link rel="stylesheet" href="/css/normalize.css">

  
<link rel="stylesheet" href="/css/skeleton.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
<link rel="stylesheet" href="/css/prism-dark.css">

  
<link rel="stylesheet" href="/css/prism-line-numbers.css">

  <!-- User css -->
  
  
<link rel="stylesheet" href="/css/user.css">

  

  <!-- Favicon
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <link rel="icon" type="image/png" href="">

  <!-- Custom Theme Color Style
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <style>
  a:not(.icon) {
    text-decoration-color: #0FA0CE;
    background-image: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0) 50%,
      #0FA0CE 50%
    );
  }
  blockquote {
    border-left: 8px solid #0FA0CE;
  }
  .nanobar .bar {
    background: #0FA0CE;
  }
  .button.button-primary:hover,
  button.button-primary:hover,
  input[type="submit"].button-primary:hover,
  input[type="reset"].button-primary:hover,
  input[type="button"].button-primary:hover,
  .button.button-primary:focus,
  button.button-primary:focus,
  input[type="submit"].button-primary:focus,
  input[type="reset"].button-primary:focus,
  input[type="button"].button-primary:focus {
    background-color: #0FA0CE;
    border-color: #0FA0CE;
  }
  input[type="email"]:focus,
  input[type="number"]:focus,
  input[type="search"]:focus,
  input[type="text"]:focus,
  input[type="tel"]:focus,
  input[type="url"]:focus,
  input[type="password"]:focus,
  textarea:focus,
  select:focus {
    border: 1px solid #0FA0CE;
  }
</style>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div class="container">
    <div class="row">
      <div>

        <div class="row">
  <div class="two columns" style="max-width: 50px">
    <h1 class="mt-2 mode">
      <div onclick=setDarkMode(true) id="darkBtn">ğŸŒ‘</div>
      <div onclick=setDarkMode(false) id="lightBtn" class=hidden>â˜€ï¸</div>
      <script >
        if (localStorage.getItem('preferredTheme') == 'dark') {
          setDarkMode(true)
        }
        function setDarkMode(isDark) {
          var darkBtn = document.getElementById('darkBtn')
          var lightBtn = document.getElementById('lightBtn')
          if (isDark) {
            lightBtn.style.display = "block"
            darkBtn.style.display = "none"
            localStorage.setItem('preferredTheme', 'dark');
          } else {
            lightBtn.style.display = "none"
            darkBtn.style.display = "block"
            localStorage.removeItem('preferredTheme');
          }
          document.body.classList.toggle("darkmode");
        }
      </script>
    </h1>
  </div>

  <div class="six columns ml-1">
    <h1 class="mt-2" style="font-weight: 700;">
      å°ç¾Šå„¿çš„å¿ƒæƒ…å¤©ç©º
    </h1>
  </div>

  <div class="twelve columns">
    <div class="row">
      <div class="nine columns left">
        <a href="/">æˆ‘çš„åšå®¢</a>
        
          
          <a target="_blank" rel="noopener" href="https://www.xylab.fun/" class="ml">æˆ‘çš„å®éªŒ</a>
          
        
          
          <a href="/links" class="ml">å‹æƒ…é“¾æ¥</a>
          
        
      </div>
    </div>
    <hr style="margin-bottom: 2.6rem">
  </div>
</div>

        <div class="trans">
            <h2>EFCoreæŸ¥ç¼ºè¡¥æ¼ï¼ˆäºŒï¼‰ï¼šæŸ¥è¯¢</h2>
  <p class="mbb-2">Feb 15, 2021 ç”± å°ç¾Š</p>

  <p>ç¬¬ 20 è½® TechEmpower è¯„æµ‹ç»“æœå‡ºç‚‰äº†ï¼Œ<a target="_blank" rel="noopener" href="http://ASP.NET">ASP.NET</a> Core çš„ Plaintext æˆç»©ååˆ—å‰èŒ…ï¼Œå¸¦ç€ EFCore çš„æµ‹è¯•å´åœ¨ Single query / Multiple queries / Fortunes ä¸­è½äº†ä¸‹é£ï¼Œæˆç»©è¿œä¸å¦‚ dapperï¼Œæ›´ä¸å¦‚ç›´æ¥ <a target="_blank" rel="noopener" href="http://ado.net">ado.net</a>ã€‚</p>
<p>äººäººéƒ½è¯´ EFCore æ€§èƒ½å·®ï¼Œäººäººéƒ½åœ¨å†™æ€§èƒ½ä½çš„ä»£ç â€¦â€¦</p>
<p>EFCore æ˜¯å¦‚ä½•è¿›è¡ŒæŸ¥è¯¢çš„ï¼Ÿé™¤äº†æŸ¥è¯¢è¯­å¥æœ¬èº«çš„åˆç†æ€§ï¼ŒEFCore æœ¬èº«çš„æ€§èƒ½ç“¶é¢ˆåˆä¼šå‡ºç°åœ¨å“ªé‡Œå‘¢ï¼Ÿå¦‚ä½•è®© EFCore çš„æŸ¥è¯¢å˜å¾—æ›´å¿«å‘¢ï¼Ÿ</p>
<p>ä»Šå¤©ï¼Œå…ˆä» <code>IQueryable</code> è¿™ä¸ªæ¥å£è¯´èµ·ã€‚</p>
<h4 id="iqueryable-ä¸-ienumerable"><a class="markdownIt-Anchor" href="#iqueryable-ä¸-ienumerable"></a> IQueryable ä¸ IEnumerable</h4>
<p><code>IEnumerable&lt;&gt;</code> çš„æ ¸å¿ƒä½œç”¨æ˜¯æä¾›ä¸€äº›åŸºç¡€æ•°æ®é€šè¿‡ <code>GetEnumerator</code> å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ª <code>IEnumerator&lt;&gt;</code>ã€‚</p>
<p><code>IEnumerator&lt;&gt;</code> æ˜¯ä¸€ä¸ªéå¸¸å•çº¯çš„å•å‘è¿­ä»£å™¨ï¼Œä½ å¯ä»¥åƒç³»ç»Ÿè‡ªå¸¦çš„é›†åˆç±»é‚£æ ·æ‰‹åŠ¨å®ç°ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥ä½ å¯ä»¥é€šè¿‡è‡ªå·±ç¼–å†™ <code>yield return</code> / <code>yield break</code> è¯­å¥ï¼Œè®©ç¼–è¯‘å™¨å°†ä½ çš„ç¨‹åºæ§åˆ¶æµå’Œå˜é‡çŠ¶æ€ä¿å­˜åœ¨ç¼–è¯‘å™¨ç¿»è¯‘è®¾è®¡çš„ä¸“æœ‰ <code>Enumerator</code> ä¸­ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>System.Linq</code> è¿™ä¸ªå‘½åç©ºé—´æä¾›äº†å¤§é‡é’ˆå¯¹ <code>IEnumerable&lt;&gt;</code> çš„æ‹“å±•ã€‚è¿™äº›æ‹“å±•å°† <code>IEnumerator&lt;&gt;</code> ä»¬é€šè¿‡ç±»ä¼¼äºè´£ä»»é“¾æ¨¡å¼çš„æ–¹æ³•ç»„åˆèµ·æ¥ï¼Œæä¾›äº†å¾ˆå¤šç¥å¥‡çš„ LINQ åŠŸèƒ½ã€‚</p>
<p>è€Œ <code>IQueryable&lt;&gt;</code> æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p><code>IQueryable&lt;&gt;</code> æ¥å£é™¤äº†å®ç° <code>IEnumerable&lt;&gt;</code> ä»¥å¤–ï¼Œè¿˜æœ‰ä¸‰ä¸ªæˆå‘˜</p>
<ul>
<li><code>Expression</code>ï¼šä¿å­˜äº†ä¸€ä¸ªè¡¨è¾¾å¼æ ‘</li>
<li><code>ElementType</code>ï¼šè¿™ä¸ª <code>IQueryable&lt;&gt;</code> çš„è¿”å›ç±»å‹</li>
<li><code>Provider</code>ï¼šä¸€ä¸ª <code>IQueryProvider</code> å®ä¾‹å¯¹è±¡</li>
</ul>
<p>è€Œ <code>IQueryProvider</code> åˆ™æœ‰è¿™æ ·å‡ ä¸ªæˆå‘˜å‡½æ•°</p>
<ul>
<li><code>IQueryable&lt;&gt; CreateQuery(Expression expression)</code> æ ¹æ®ä¼ å…¥çš„è¡¨è¾¾å¼æ ‘æ„å»ºä¸€ä¸ª <code>IQueryable</code> å¯¹è±¡</li>
<li><code>TResult Execute(Expression expression)</code> æ‰§è¡Œè¿™ä¸ªè¡¨è¾¾å¼ï¼Œè·å¾—å¯¹åº”ç»“æœ</li>
</ul>
<p>å†å‚è€ƒ <code>System.Linq.Queryable</code> å¯¹ <code>IQueryable&lt;&gt;</code> çš„æ‹“å±•å‡½æ•°çš„å®ç°</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// System.Linq.Queryable</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token generic-method"><span class="token function">Count</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TSource<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IQueryable<span class="token punctuation">&lt;</span>TSource<span class="token punctuation">></span></span> source<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> Error<span class="token punctuation">.</span><span class="token function">ArgumentNull</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> source<span class="token punctuation">.</span>Provider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Execute</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
        Expression<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>
            <span class="token keyword">null</span><span class="token punctuation">,</span>
            CachedReflectionInfo<span class="token punctuation">.</span><span class="token function">Count_TSource_1</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TSource</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            source<span class="token punctuation">.</span>Expression
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IQueryable<span class="token punctuation">&lt;</span>TSource<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">Where</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TSource<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IQueryable<span class="token punctuation">&lt;</span>TSource<span class="token punctuation">></span></span> source<span class="token punctuation">,</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>TSource<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">></span><span class="token punctuation">></span></span> predicate<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> Error<span class="token punctuation">.</span><span class="token function">ArgumentNull</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>predicate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> Error<span class="token punctuation">.</span><span class="token function">ArgumentNull</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>predicate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> source<span class="token punctuation">.</span>Provider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateQuery</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TSource<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
        Expression<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>
            <span class="token keyword">null</span><span class="token punctuation">,</span>
            CachedReflectionInfo<span class="token punctuation">.</span><span class="token function">Where_TSource_2</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TSource</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            source<span class="token punctuation">.</span>Expression<span class="token punctuation">,</span> Expression<span class="token punctuation">.</span><span class="token function">Quote</span><span class="token punctuation">(</span>predicate<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é‚£ä¹ˆæˆ‘ä»¬æœ‰å¦‚ä¸‹ç»“è®º</p>
<ul>
<li><code>IQueryable&lt;&gt;</code> ä¿å­˜ç€ä¸€ä¸ªæŸ¥è¯¢è¡¨è¾¾å¼æ ‘å’Œä¸€ä¸ª <code>IQueryProvider</code></li>
<li><code>IQueryProvider</code> æ”¯æ’‘ç€ <code>IQueryable&lt;&gt;</code> çš„åˆ›å»ºå’ŒæŸ¥è¯¢æ‰§è¡Œ</li>
<li><code>IQueryable&lt;&gt;</code> çš„æ‹“å±•å‡½æ•°ä»¬ä»…ä»…æ˜¯å°†è¡¨è¾¾å¼æ ‘æ‹¼æ¥æˆä¸å‡½æ•°è°ƒç”¨ç›¸åŒå½¢æ€çš„è¡¨è¾¾å¼</li>
</ul>
<p><img src="queryable-expression.png" alt="" /></p>
<p>è€Œåœ¨ EFCore ä¸­ï¼Œå®Œæˆè¿™æ ·åŠŸèƒ½çš„ç±»åˆ™æ˜¯ <code>EntityQueryable&lt;&gt;</code> å’Œ <code>EntityQueryProvider</code>ã€‚åè€…åœ¨ EFCore çš„ä¾èµ–æ³¨å…¥å®¹å™¨ä¸­æ˜¯ Scoped æœåŠ¡ <code>IAsyncQueryProvider</code> çš„å®ç°ï¼Œå®Œæˆæ‰€æœ‰çš„ <code>IQueryable&lt;&gt;</code> çš„åˆ›å»ºï¼Œå¹¶å°†æ‰€æœ‰çš„ <code>Execute</code> å’Œ <code>ExecuteAsync</code> çš„è¯·æ±‚è½¬å‘ç»™ <code>IQueryCompiler</code> è¿™ä¸€æœåŠ¡ã€‚</p>
<p>è€Œ <code>IQueryCompiler</code> ä¸­çš„æ‰§è¡Œä»£ç å¤§çº¦æ˜¯è¿™æ ·çš„</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler</span>
<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">TResult</span> <span class="token generic-method"><span class="token function">Execute</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">Expression</span> query<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    Check<span class="token punctuation">.</span><span class="token function">NotNull</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> queryContext <span class="token operator">=</span> _queryContextFactory<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    query <span class="token operator">=</span> <span class="token function">ExtractParameters</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> queryContext<span class="token punctuation">,</span> _logger<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> compiledQuery
        <span class="token operator">=</span> _compiledQueryCache
            <span class="token punctuation">.</span><span class="token function">GetOrAddQuery</span><span class="token punctuation">(</span>
                _compiledQueryCacheKeyGenerator<span class="token punctuation">.</span><span class="token function">GenerateCacheKey</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token generic-method"><span class="token function">CompileQueryCore</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>_database<span class="token punctuation">,</span> query<span class="token punctuation">,</span> _model<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">compiledQuery</span><span class="token punctuation">(</span>queryContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å…¶ä¸­</p>
<ul>
<li><code>_compiledQueryCache</code> æ˜¯ä¸€ä¸ªç”± <code>IMemoryCache</code> é©±åŠ¨çš„ç¼“å­˜</li>
<li><code>_compiledQueryCacheKeyGenerator</code> æ˜¯å°†è¯¥è¡¨è¾¾å¼ä¸æ•°æ®åº“æ¨¡å‹ã€æ•°æ®åº“é©±åŠ¨ç­‰ä¿¡æ¯çš„ Hash å€¼åˆå¹¶äº§ç”Ÿä¸€ä¸ªå¯¹åº”çš„ <code>QueryCacheKey</code></li>
<li><code>_queryContextFactory</code> ç”¨äºç”Ÿæˆä¸€ä¸ª <code>QueryContext</code> å®ä¾‹</li>
<li><code>ExtractParameters</code> å°†æŸ¥è¯¢è¡¨è¾¾å¼ä¸­çš„é—­åŒ…å˜é‡ç­‰è®¡ç®—å®Œæ¯•å¹¶åŠ å…¥ <code>queryContext</code> å®ä¾‹</li>
<li><code>compiledQuery</code> æ˜¯ä¸€ä¸ª <code>Func&lt;QueryContext, TResult&gt;</code> å®ä¾‹ï¼Œåˆç§°ä¸º <code>QueryExecutor</code></li>
</ul>
<p>è€Œå…¶ä¸­ <code>QueryContext</code> æ”¯æŒå’Œæä¾›</p>
<ul>
<li>å¹¶è¡Œæ£€æµ‹ï¼ˆä¹Ÿå°±æ˜¯ EFCore ä¸€ä¸ªä¸Šä¸‹æ–‡å®ä¾‹åªèƒ½æœ‰ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„æŸ¥è¯¢è¯­å¥çš„åŸºçŸ³ï¼‰</li>
<li>æ‰§è¡Œé€»è¾‘ï¼ˆä¾‹å¦‚å¤±è´¥é‡è¯•ï¼‰</li>
<li>å¼‚æ­¥ä»»åŠ¡çš„ CancellationToken</li>
<li>å„ç§æ—¥å¿—è¾“å‡º</li>
<li>æŸ¥è¯¢å‚æ•°çš„æ·»åŠ å’Œè¯»å–</li>
<li>å®ä½“è·Ÿè¸ªå’ŒçŠ¶æ€ç®¡ç†</li>
</ul>
<p>åœ¨å…³ç³»å‹æ•°æ®åº“é©±åŠ¨ä¸­ï¼Œ<code>RelationalQueryContext</code> å¦å¤–é™„åŠ </p>
<ul>
<li>æ•°æ®åº“è¿æ¥</li>
<li>ç”Ÿæˆ SQL ç‰‡æ®µçš„å·¥å‚ç±»</li>
</ul>
<p>æˆ‘ä»¬æ¯æ¬¡è¦æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢ï¼Œå°±è¦å…ˆåœ¨è¿™ä¸ªå†…å­˜ç¼“å­˜ä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»æœ‰ç¼–è¯‘å¥½çš„æ‰§è¡Œè¯­å¥ï¼›è€Œè¿™ä¸ªç¼“å­˜çš„é”®éœ€è¦åˆ©ç”¨è¡¨è¾¾å¼æ ‘æ¥ç”Ÿæˆã€‚å¦‚æœæˆ‘ä»¬çš„æŸ¥è¯¢è¿‡äºå¤æ‚ï¼Œåˆ™ä¼šå¯¹ç¼“å­˜å¸¦æ¥ä¸€å®šçš„æ€§èƒ½è´Ÿæ‹…ã€‚</p>
<h4 id="expression-æ ‘ä¸-efcompilequery"><a class="markdownIt-Anchor" href="#expression-æ ‘ä¸-efcompilequery"></a> Expression æ ‘ä¸ EF.CompileQuery</h4>
<p>æˆ‘ä»¬ç¨åè®¨è®º <code>CompileQueryCore</code> çš„ä½œç”¨ã€‚å…ˆæ¥è®¨è®ºä¸€ä¸‹è¡¨è¾¾å¼æ ‘å§ã€‚</p>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒEFCore çš„å¼ºç±»å‹ç‰¹æ€§æ˜¯ç”±è¡¨è¾¾å¼æ ‘è¿™ä¸ªç©æ„å¸¦æ¥çš„ã€‚</p>
<p>ç¼–è¯‘å™¨ä¸ºäº†å‡å°‘äººä¸ºæ„å»ºè¡¨è¾¾å¼æ ‘çš„è´Ÿæ‹…ï¼Œæä¾›äº†è¯­æ³•ç³–ï¼Œè®©æˆ‘ä»¬å¯ä»¥åƒå†™ Lambda å‡½æ•°ä¸€æ ·ä¹¦å†™è¡¨è¾¾å¼ã€‚ç„¶è€Œç¼–è¯‘å™¨å¹¶æ²¡æœ‰å¼€æ´ï¼Œè€Œæ˜¯å®æ‰“å®çš„è¿›è¡Œäº†è¡¨è¾¾å¼æ ‘çš„æ„å»ºã€‚</p>
<p><img src="exp-tree-il.png" alt="" /></p>
<p>å¯ä»¥åœ¨å›¾ä¸Šçœ‹åˆ°ï¼Œæˆ‘ä»¬ç»å¸¸æ‰§è¡Œçš„æ ¹æ® ID æŸ¥æ‰¾ä¸€ä¸ªå®ä½“çš„æ“ä½œä¼šäº§ç”Ÿå¦‚æ­¤ä¹‹å¤šçš„ä¸­é—´ä»£ç ã€‚ç”šè‡³ï¼Œè“æ¡†å†…è¿˜æœ‰é—­åŒ…å˜é‡æ•æ‰çš„æ­¥éª¤ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬çš„æŸ¥è¯¢å¾ˆç®€å•ï¼Œé‚£ä¼¼ä¹ä¹Ÿæ²¡ä»€ä¹ˆâ€¦â€¦å¦‚æœæˆ‘ä»¬è¦æ‰§è¡Œä¸€ä¸ªè¶…çº§å¤æ‚çš„æŸ¥è¯¢ï¼Œåˆè¦ join å¥½å‡ ä¸ªè¡¨åˆè¦ concat è¿˜è¦ group å‘¢ï¼Ÿ</p>
<p>è¡¨è¾¾å¼æ ‘æ¯•ç«Ÿæ˜¯è¡¨è¾¾å¼æ ‘ï¼Œä¸ºäº†åˆ›å»ºè¡¨è¾¾å¼æ ‘ï¼Œè¿™ä¹ˆå¤šä¸­é—´ä»£ç æ€»æ˜¯éœ€è¦æ‰§è¡Œçš„ã€‚</p>
<p>æœ‰æ²¡æœ‰åŠæ³•ç›´æ¥è·³è¿‡è¿™ä¹ˆå¤šè¡¨è¾¾å¼æ ‘çš„æ„å»ºå‘¢ï¼Ÿæœ‰çš„ã€‚çœ‹ <code>EF.CompileQuery</code>ã€‚å…¶ä¸­çš„ä¸€ä¸ªå…¸å‹å‡½æ•°</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Func<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">,</span> IEnumerable<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">CompileQuery</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TContext<span class="token punctuation">,</span> TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NotNull</span></span><span class="token punctuation">]</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">,</span> IQueryable<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span> queryExpression<span class="token punctuation">)</span>
    <span class="token keyword">where</span> <span class="token class-name">TContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
    <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CompiledQuery<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">,</span> IEnumerable<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span>queryExpression<span class="token punctuation">)</span><span class="token punctuation">.</span>Execute<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œå®é™…ä¸Šæ˜¯æ„å»ºäº†ä¸€ä¸ª <code>CompileQuery&lt;,&gt;</code> ç±»å‹çš„å¯¹è±¡ï¼Œå¹¶ä¸”å°†ä»–çš„ Execute å‡½æ•°æ‰“åŒ…æˆå§”æ‰˜è¿”å›ã€‚</p>
<p>ä½ å¯èƒ½ä¼šé—®ï¼Œè¿™ä¸æ˜¯è¿˜éœ€è¦è¡¨è¾¾å¼æ ‘å—ï¼Ÿ</p>
<p>é‚£ä¹ˆè¯·å›é¡¾å®˜æ–¹æ–‡æ¡£ä¸­è¿™ä¸ªå‡½æ•°çš„ä½¿ç”¨åœºæ™¯ï¼šå°†è¯¥å‡½æ•°è¿”å›çš„å§”æ‰˜æ”¾åœ¨ é™æ€å­—æ®µ æˆ–è€… å•ä¾‹çš„æˆå‘˜å˜é‡ ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºæŸä¸ªå‚æ•°è®¾è®¡å¥½äº†çš„å‡½æ•°ï¼Œè¿™ä¸ª <code>EF.CompileQuery</code> å‡½æ•°ç†åº”åªæ‰§è¡Œä¸€æ¬¡ã€‚</p>
<p>CompiledQuery å¯¹è±¡åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼Œé€šè¿‡æ¥ä¸‹æ¥çš„ä»£ç åˆ›å»ºä¸€ä¸ª <code>Func&lt;QueryContext, TResult&gt;</code> å§”æ‰˜ï¼›åœ¨è¿™ä¸ªå§”æ‰˜ä¸­ï¼Œæœ¬æ¬¡æ‰§è¡Œäº§ç”Ÿçš„ SQL è¯­å¥è¡¨è¾¾å¼æ ‘ã€SQL è¯­å¥æ–‡æœ¬ä¼šè¢«ç¼“å­˜ä¸‹æ¥ï¼›åœ¨ç¬¬äºŒæ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±è·³è¿‡å¯¹è¡¨è¾¾å¼æ ‘çš„å¤„ç†ï¼Œç›´æ¥æ‰§è¡Œä¸Šé¢é‚£ä¸ªå§”æ‰˜ï¼Œç”šè‡³åœ¨ç‰¹å®šæƒ…å†µä¸‹å¿«è¿›åˆ°ç›´æ¥æ‰§è¡Œ SQL è¯­å¥æ–‡æœ¬äº†ã€‚</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler</span>
<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Func<span class="token punctuation">&lt;</span>QueryContext<span class="token punctuation">,</span> TResult<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">CreateCompiledQuery</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">Expression</span> query<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    Check<span class="token punctuation">.</span><span class="token function">NotNull</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    query <span class="token operator">=</span> <span class="token function">ExtractParameters</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> _queryContextFactory<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _logger<span class="token punctuation">,</span> <span class="token named-parameter punctuation">parameterize</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token generic-method"><span class="token function">CompileQueryCore</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>_database<span class="token punctuation">,</span> query<span class="token punctuation">,</span> _model<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ˜¯ä¸æ˜¯æ„Ÿè§‰ä¼šå¿«ä¸Šå¾ˆå¤šï¼Ÿæˆ‘ä»¬å¯ä»¥ç›´æ¥è·å¾—è¿™ä¸ªå§”æ‰˜ï¼Œè€Œä¸æ˜¯é€šè¿‡å­—å…¸æŸ¥æ‰¾ï¼Œå¯ä»¥èŠ‚çœå¾ˆå¤šæ—¶é—´ï¼›è€Œä¸”ä¸æ¶‰åŠæŸ¥è¯¢è¯­å¥ç¼“å­˜ï¼Œä¸ä¼šå­˜åœ¨ç³»ç»Ÿå†…å…¶ä»–æŸ¥è¯¢å¤ªå¤šã€æŸäº›ä¸å¸¸ç”¨æŸ¥è¯¢è¢«å®šæœŸæ¸…ç†æ‰çš„æƒ…å†µã€‚</p>
<p>ä¸ªäººè®¤ä¸ºï¼Œåœ¨éœ€è¦æ¯”è¾ƒé«˜æ€§èƒ½çš„åŒæ—¶ï¼Œåˆä¸æ˜¯ç›´æ¥æ‰§è¡Œ SQL è¯­å¥æ–‡æœ¬çš„æƒ…å†µä¸‹ï¼Œè¿™æ ·ä¸¤ç§æƒ…å†µå¯ä»¥å°è¯•ä½¿ç”¨ <code>EF.CompileQuery</code>ï¼š</p>
<ul>
<li>æŸ¥è¯¢è¡¨è¾¾å¼æ ‘å¤ªè¿‡å¤æ‚</li>
<li>é«˜é¢‘è®¿é—®è·¯å¾„ä¸Šçš„æŸ¥è¯¢</li>
</ul>
<p>å¦å¤–ï¼Œå¦‚æœæŸ¥è¯¢æ˜¯åªè¯»ï¼Œä¸æ¶‰åŠåˆ°å®ä½“çš„å¢åˆ æ”¹ï¼Œæ­¤æ—¶å®Œå…¨å¯ä»¥è€ƒè™‘åˆ°ä½¿ç”¨ <code>AsNoTracking</code> è¿™ç±»æ‹“å±•ï¼Œå°†å®ä½“æ›´æ”¹è¿½è¸ªå…³æ‰ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¯ä»¥å†æé«˜ä¸€ç‚¹æ€§èƒ½ï¼Œå¤§çº¦èƒ½ä¸ Dapper å’Œ <a target="_blank" rel="noopener" href="http://ADO.NET">ADO.NET</a> ç›´æ¥è¯»å–æ•°æ®çš„æ€§èƒ½æ¯”è‚©ï¼ˆæ²¡æœ‰æµ‹è¯•æ•°æ®ï¼‰ã€‚</p>
<p>ç¬”è€…åœ¨é˜…è¯»ç½‘ä¸Šç°å­˜çš„å¯¹ <code>EF.CompileQuery</code> çš„ä»‹ç»ä¸­ï¼Œæœ‰è¯»åˆ°è¿‡ä¸€ç¯‡è¯´è¿™ä¸ªå‡½æ•°ä¸æ¥å— <code>ToList</code> å’Œ <code>ToListAsync</code> ä¹‹ç±»çš„å‡½æ•°ï¼Œè¯´è¿™ä¸ªåŠŸèƒ½æ”¯æŒä¸å®Œå…¨ã€‚</p>
<p><code>ToList</code> æ˜¯ <code>IEnumerable&lt;&gt;</code> çš„æ‹“å±•æ–¹æ³•ï¼Œå¹¶ä¸æ˜¯ <code>IQueryable&lt;&gt;</code> çš„æ‹“å±•æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>ToList</code> å®é™…ä¸Šæ˜¯å°†ä¹‹å‰çš„ <code>IQueryable&lt;&gt;</code> è¿›è¡Œäº† <code>foreach</code> æšä¸¾ï¼Œå¹¶æ‰‹åŠ¨æ„å»º <code>List&lt;&gt;</code> å¯¹è±¡ï¼Œæ‰€ä»¥è¯´ä¸æ”¯æŒä¼¼ä¹æƒ…æœ‰å¯åŸã€‚</p>
<p>è€Œ <code>ToListAsync</code> æ˜¯ EFCore çš„æ‹“å±•æ–¹æ³•ã€‚å®é™…ä¸Šï¼Œä»–çš„ä»£ç æ˜¯è¿™æ ·çš„ï¼š</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TSource<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">ToListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TSource<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NotNull</span></span><span class="token punctuation">]</span> <span class="token keyword">this</span> <span class="token class-name">IQueryable<span class="token punctuation">&lt;</span>TSource<span class="token punctuation">></span></span> source<span class="token punctuation">,</span>
    <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TSource<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> element <span class="token keyword">in</span> source<span class="token punctuation">.</span><span class="token function">AsAsyncEnumerable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithCancellation</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        list<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯¹ï¼Œåˆ©ç”¨äº† <code>IAsyncEnumerable</code> å’Œ <code>await foreach</code> æ¥è¾¾åˆ°å¼‚æ­¥æŸ¥è¯¢çš„ç›®çš„ã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>ToList</code>ã€<code>ToArray</code>ã€<code>ToDictionary</code> ç±»ä¼¼åŠŸèƒ½çš„æ—¶å€™ï¼Œä½¿ç”¨é‚£ä¸ª <code>Func&lt;TContext, IAsyncEnumerable&lt;TResult&gt;&gt;</code> ç„¶åæ‰‹åŠ¨æ„æ¶é›†åˆå°±å¥½äº†ã€‚</p>
<p>è¿™é‡Œå†ç®€å•ç»™å‡ ä¸ªä½¿ç”¨è¿™ä¸ªå‡½æ•°ä½¿ç”¨çš„ä¾‹å­å§ã€‚</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>MyContext<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> Task<span class="token punctuation">&lt;</span>User<span class="token punctuation">></span><span class="token punctuation">></span></span> _findUser <span class="token operator">=</span>
    EF<span class="token punctuation">.</span><span class="token function">CompileAsyncQuery</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token class-name">MyContext</span> context<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span> <span class="token operator">=></span> context<span class="token punctuation">.</span>Users<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>u <span class="token operator">=></span> u<span class="token punctuation">.</span>Id <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>MyContext<span class="token punctuation">,</span> IAsyncEnumerable<span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">></span><span class="token punctuation">></span></span> _listUsers <span class="token operator">=</span>
    EF<span class="token punctuation">.</span><span class="token function">CompileAsyncQuery</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token class-name">MyContext</span> context<span class="token punctuation">)</span> <span class="token operator">=></span> context<span class="token punctuation">.</span>Users<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>u <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UserDto</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> u<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>MyContext<span class="token punctuation">,</span> DateTimeOffset<span class="token punctuation">,</span> CancellationToken<span class="token punctuation">,</span> Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">></span><span class="token punctuation">></span></span> _countUsers <span class="token operator">=</span>
    EF<span class="token punctuation">.</span><span class="token function">CompileAsyncQuery</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token class-name">MyContext</span> context<span class="token punctuation">,</span> <span class="token class-name">DateTimeOffset</span> time<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> _<span class="token punctuation">)</span> <span class="token operator">=></span> context<span class="token punctuation">.</span>Users<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>u <span class="token operator">=></span> u<span class="token punctuation">.</span>RegisterTime <span class="token operator">&lt;</span> time<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">DoAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token function">CreateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">_findUser</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">233</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> item <span class="token keyword">in</span> <span class="token function">_listUsers</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithCancellation</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        list<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> count <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">_countUsers</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> DateTimeOffset<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥åˆ›å»ºå¸¦æœ‰ CancellationToken çš„å¼‚æ­¥ç‰ˆæœ¬ã€‚åŒæ­¥ç‰ˆæœ¬å°±ä¸ç”¨ CancellationToken äº†ã€‚</p>
<h4 id="çœŸæ­£çš„æŸ¥è¯¢ç¼–è¯‘ä¸æ‰§è¡Œ"><a class="markdownIt-Anchor" href="#çœŸæ­£çš„æŸ¥è¯¢ç¼–è¯‘ä¸æ‰§è¡Œ"></a> çœŸæ­£çš„æŸ¥è¯¢ç¼–è¯‘ä¸æ‰§è¡Œ</h4>
<p>æˆ‘ä»¬éœ€è¦ç»“åˆ SqlServer è¿™ä¸ªå…³ç³»å‹æ•°æ®åº“è§£é‡Šæ‰€è°“çš„ <code>QueryExecutor</code>ã€‚å…¶ä»–å…³ç³»å‹æ•°æ®åº“çš„å¤§è‡´æ„å»ºè¿‡ç¨‹å…¶å®å·®ä¸å¤šï¼Œéå…³ç³»å‹çš„ InMemory å’Œ Cosmos çš„é©±åŠ¨ç”¨çš„å°‘å°±ä¸è§£é‡Šäº†å“ˆã€‚</p>
<p>ä»¥ <code>context.Set&lt;User&gt;().Where(u =&gt; u.Id != id).ToList()</code> è¿™ä¸€æŸ¥è¯¢çš„ç¿»è¯‘ä¸ºä¾‹ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªæŸ¥è¯¢çš„ <code>QueryExecutor</code> æ˜¯ <code>Func&lt;QueryContext, IEnumerable&lt;User&gt;&gt;</code>ï¼Œä¼ å…¥ <code>queryContext</code> ä¼šè¿”å›ä¸€ä¸ª <code>IEnumerable</code> å¯¹è±¡ã€‚</p>
<p>åœ¨ EFCore 3.1 ä¸­ï¼Œè¿”å›çš„æ˜¯ <code>QueryingEnumerable</code>ï¼›åœ¨ EFCore 5.0 ä¸­ï¼Œè¿”å› <code>SingleQueryingEnumerable</code> æˆ–è€… <code>SplitQueryingEnumerable</code> æˆ–è€… <code>FromSqlQueryingEnumerable</code>ã€‚5.0 çš„æ”¹åŠ¨æ˜¯å› ä¸ºå¸¦æ¥äº† <code>AsSplitQuery</code> è¿™ä¸ªæ‹“å±•ï¼Œé¿å…ç¬›å¡å°”çˆ†ç‚¸çš„é—®é¢˜ã€‚</p>
<p>å…ˆè·³è¿‡ <code>QueryExecutor</code> å‡½æ•°ä½“ï¼Œçœ‹çœ‹è¿”å›å€¼ã€‚</p>
<p>ä»¥ <code>SingleQueryingEnumerable</code> ä¸ºä¾‹ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒå®ç°äº† <code>IEnumerable</code> å’Œ <code>IAsyncEnumerable</code>ã€‚ä»¥ä¸‹æ˜¯ <code>GetEnumerator</code> ç»“æœçš„ <code>MoveNext</code> å’Œ <code>InitializeReader</code> çš„å®ç°ã€‚</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">InitializeReader</span><span class="token punctuation">(</span><span class="token class-name">DbContext</span> _<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">bool</span></span> result<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    EntityFrameworkEventSource<span class="token punctuation">.</span>Log<span class="token punctuation">.</span><span class="token function">QueryExecuting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> relationalCommand <span class="token operator">=</span> _relationalCommandCache<span class="token punctuation">.</span><span class="token function">GetRelationalCommand</span><span class="token punctuation">(</span>_relationalQueryContext<span class="token punctuation">.</span>ParameterValues<span class="token punctuation">)</span><span class="token punctuation">;</span>

    _dataReader <span class="token operator">=</span> relationalCommand<span class="token punctuation">.</span><span class="token function">ExecuteReader</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RelationalCommandParameterObject</span><span class="token punctuation">(</span>
            _relationalQueryContext<span class="token punctuation">.</span>Connection<span class="token punctuation">,</span>
            _relationalQueryContext<span class="token punctuation">.</span>ParameterValues<span class="token punctuation">,</span>
            _relationalCommandCache<span class="token punctuation">.</span>ReaderColumns<span class="token punctuation">,</span>
            _relationalQueryContext<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>
            _relationalQueryContext<span class="token punctuation">.</span>CommandLogger<span class="token punctuation">,</span>
            _detailedErrorsEnabled<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _resultCoordinator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SingleQueryResultCoordinator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _relationalQueryContext<span class="token punctuation">.</span><span class="token function">InitializeStateManager</span><span class="token punctuation">(</span>_standAloneStateManager<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">MoveNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span>_relationalQueryContext<span class="token punctuation">.</span>ConcurrencyDetector<span class="token punctuation">.</span><span class="token function">EnterCriticalSection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_dataReader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                _relationalQueryContext<span class="token punctuation">.</span>ExecutionStrategyFactory<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> InitializeReader<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> hasNext <span class="token operator">=</span> _resultCoordinator<span class="token punctuation">.</span>HasNext <span class="token operator">??</span> _dataReader<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Current <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>hasNext<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    _resultCoordinator<span class="token punctuation">.</span>ResultReady <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    _resultCoordinator<span class="token punctuation">.</span>HasNext <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    Current <span class="token operator">=</span> <span class="token function">_shaper</span><span class="token punctuation">(</span>
                        _relationalQueryContext<span class="token punctuation">,</span> _dataReader<span class="token punctuation">.</span>DbDataReader<span class="token punctuation">,</span> _resultCoordinator<span class="token punctuation">.</span>ResultContext<span class="token punctuation">,</span>
                        _resultCoordinator<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_resultCoordinator<span class="token punctuation">.</span>ResultReady<span class="token punctuation">)</span>
                    <span class="token punctuation">&#123;</span>
                        <span class="token comment">// We generated a result so null out previously stored values</span>
                        _resultCoordinator<span class="token punctuation">.</span>ResultContext<span class="token punctuation">.</span>Values <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_dataReader<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">&#123;</span>
                        _resultCoordinator<span class="token punctuation">.</span>HasNext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token comment">// Enumeration has ended, materialize last element</span>
                        _resultCoordinator<span class="token punctuation">.</span>ResultReady <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        Current <span class="token operator">=</span> <span class="token function">_shaper</span><span class="token punctuation">(</span>
                            _relationalQueryContext<span class="token punctuation">,</span> _dataReader<span class="token punctuation">.</span>DbDataReader<span class="token punctuation">,</span> _resultCoordinator<span class="token punctuation">.</span>ResultContext<span class="token punctuation">,</span>
                            _resultCoordinator<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">return</span> hasNext<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _queryLogger<span class="token punctuation">.</span><span class="token function">QueryIterationFailed</span><span class="token punctuation">(</span>_contextType<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">throw</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å…¶ä¸­</p>
<ul>
<li><code>ExecutionStrategy</code> å¤„ç†æŸ¥è¯¢é‡è¯•ä¹‹ç±»çš„æ‰§è¡Œé€»è¾‘</li>
<li><code>_relationalCommandCache</code> ä¿å­˜äº†ç¿»è¯‘çš„ SQL è¡¨è¾¾å¼å’Œè¯­å¥æ–‡æœ¬</li>
<li><code>_dataReader</code> ä¿å­˜ç€ <a target="_blank" rel="noopener" href="http://ADO.NET">ADO.NET</a> ä¸­å¸¸ç”¨çš„ <code>DbCommand</code>ï¼Œ<code>DbDataReader</code>ï¼Œ<code>DbConnection</code> ç­‰å·¥å…·ï¼Œæ˜¯çš„ï¼Œåº•å±‚è¯»å–åº“å°±æ˜¯ <a target="_blank" rel="noopener" href="http://ADO.NET">ADO.NET</a></li>
<li><code>_resultCoordinator</code> å°† <a target="_blank" rel="noopener" href="http://ADO.NET">ADO.NET</a> è¯»å–çš„ä¸€è¡Œç»“æœå­˜å…¥ <code>ResultContext</code>ï¼Œç„¶åå½“ä¸€æ¡è®°å½•å®Œæ•´è¯»å–ä»¥åï¼ˆå¦‚æœæœ‰é›†åˆ Includeï¼Œåˆ™æ˜¯é›†åˆæ•´ä¸ªè¯»å–å®Œæˆï¼‰ï¼Œç”± <code>_shaper</code> è½¬æ¢æˆæœ€ç»ˆå®ä½“</li>
</ul>
<p>è¿™ä¸ª <code>QueryingEnumerable</code> æ˜¯å¦‚ä½•æ„å»ºå‡ºæ¥çš„ï¼Ÿç»ˆäºåˆ°äº†å–œé—»ä¹è§çš„ <code>CompileQueryCore</code> å‡½æ•°è®²è§£äº†ã€‚</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler</span>
<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Func<span class="token punctuation">&lt;</span>QueryContext<span class="token punctuation">,</span> TResult<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">CompileQueryCore</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NotNull</span></span><span class="token punctuation">]</span> <span class="token class-name">IDatabase</span> database<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NotNull</span></span><span class="token punctuation">]</span> <span class="token class-name">Expression</span> query<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NotNull</span></span><span class="token punctuation">]</span> <span class="token class-name">IModel</span> model<span class="token punctuation">,</span>
    <span class="token class-name"><span class="token keyword">bool</span></span> <span class="token keyword">async</span><span class="token punctuation">)</span>
    <span class="token operator">=></span> database<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CompileQuery</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// Microsoft.EntityFrameworkCore.Storage.Database</span>
<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Func<span class="token punctuation">&lt;</span>QueryContext<span class="token punctuation">,</span> TResult<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">CompileQuery</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">Expression</span> query<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">bool</span></span> <span class="token keyword">async</span><span class="token punctuation">)</span>
    <span class="token operator">=></span> Dependencies<span class="token punctuation">.</span>QueryCompilationContextFactory
        <span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateQueryExecutor</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// Microsoft.EntityFrameworkCore.Query.QueryCompilationContext</span>
<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Func<span class="token punctuation">&lt;</span>QueryContext<span class="token punctuation">,</span> TResult<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">CreateQueryExecutor</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">Expression</span> query<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    query <span class="token operator">=</span> _queryTranslationPreprocessorFactory<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Convert EntityQueryable to ShapedQueryExpression</span>
    query <span class="token operator">=</span> _queryableMethodTranslatingExpressionVisitorFactory<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query <span class="token operator">=</span> _queryTranslationPostprocessorFactory<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Inject actual entity materializer</span>
    <span class="token comment">// Inject tracking</span>
    query <span class="token operator">=</span> _shapedQueryCompilingExpressionVisitorFactory<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// If any additional parameters were added during the compilation phase (e.g. entity equality ID expression),</span>
    <span class="token comment">// wrap the query with code adding those parameters to the query context</span>
    query <span class="token operator">=</span> <span class="token function">InsertRuntimeParameters</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> queryExecutorExpression <span class="token operator">=</span> Expression<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Lambda</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>QueryContext<span class="token punctuation">,</span> TResult<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
        query<span class="token punctuation">,</span>
        QueryContextParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> queryExecutorExpression<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">finally</span>
    <span class="token punctuation">&#123;</span>
        Logger<span class="token punctuation">.</span><span class="token function">QueryExecutionPlanned</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ExpressionPrinter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queryExecutorExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å—¯ï¼Œè¿™ç©æ„â€¦â€¦è€å¥—å¨ƒäººäº†ã€‚</p>
<p>è¿™é‡Œçš„ä»£ç å…¶å®æŒºæŠ½è±¡çš„ã€‚å¦å¤–ä¸è¦è¢«é‚£ä¸ª <code>.Compile()</code> å“åˆ°ï¼Œé‚£ä¸ªåªæ˜¯åˆ©ç”¨è¡¨è¾¾å¼æ ‘æŠŠåŠ¨æ€æ„å»ºçš„å‡½æ•°ä½“ç”Ÿæˆä¸ºçœŸæ­£çš„å§”æ‰˜å¯¹è±¡è€Œå·²ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å®ƒ Compile ä¹‹å‰çœ‹åˆ°è¿™ä¸ªå‡½æ•°ä½“å†…éƒ¨ç©¶ç«Ÿæ˜¯ä»€ä¹ˆã€‚</p>
<p>è‡³äºæŸ¥è¯¢ç¿»è¯‘è¿‡ç¨‹æœ¬èº«çš„è®¾è®¡ï¼Œè¿™æ¬¡å…ˆä¸ä»‹ç»ã€‚</p>
<p>ä¾ç„¶æ˜¯ä¸Šé¢é‚£ä¸ªä¾‹å­ï¼Œè°ƒè¯• EFCore æºä»£ç è®¾æ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶ <code>queryExecutor</code> æ˜¯è¿™æ ·çš„ï¼š</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SingleQueryingEnumerable<span class="token punctuation">&lt;</span>User<span class="token punctuation">></span></span><span class="token punctuation">(</span>
    <span class="token named-parameter punctuation">relationalQueryContext</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>RelationalQueryContext<span class="token punctuation">)</span>queryContext<span class="token punctuation">,</span>
    <span class="token named-parameter punctuation">relationalCommandCache</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span>RelationalCommandCache<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token named-parameter punctuation">shaper</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span>Func<span class="token operator">&lt;</span>QueryContext<span class="token punctuation">,</span> DbDataReader<span class="token punctuation">,</span> ResultContext<span class="token punctuation">,</span> SingleQueryResultCoordinator<span class="token punctuation">,</span> User<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token named-parameter punctuation">contextType</span><span class="token punctuation">:</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">MyContext</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token named-parameter punctuation">standAloneStateManager</span><span class="token punctuation">:</span> False<span class="token punctuation">,</span>
    <span class="token named-parameter punctuation">detailedErrorsEnabled</span><span class="token punctuation">:</span> False<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨åˆšæ‰çš„è¿‡ç¨‹ä¸­ï¼Œ <code>InsertRuntimeParameters</code> å¹¶æ²¡æœ‰å®é™…å‘æŒ¥ä½œç”¨ï¼Œå› ä¸ºé—­åŒ…æ•æ‰çš„ <code>id</code> å˜é‡æ—©åœ¨ <code>QueryCompiler.ExtractParameters</code> æ—¶å°±å˜ä¸ºäº† <code>ParameterExpression</code> å¹¶è¢«åŠ å…¥ <code>QueryContext</code>ï¼Œè€Œå¹¶æ²¡æœ‰åœ¨æŸ¥è¯¢ç¿»è¯‘è¿‡ç¨‹ä¸­ä½¿ç”¨ä»»ä½•â€œè¿è¡Œæ—¶å‚æ•°â€ã€‚</p>
<p>åœ¨ä¸ä½¿ç”¨å¯¼èˆªå±æ€§çš„æƒ…å†µä¸‹ï¼Œè¯•äº†å‡ ä¸ªå¸¸è§çš„ä¾‹å­ï¼ŒåŸºæœ¬ä¸Šéƒ½ä¸ä¼šè§¦å‘â€œè¿è¡Œæ—¶å‚æ•°â€ã€‚ç¬”è€…æ‰¾åˆ°äº†è¿™æ ·çš„ä¸¤ä¸ªä¾‹å­ï¼š</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Tenant</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ICollection<span class="token punctuation">&lt;</span>User<span class="token punctuation">></span></span> Users <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Tenant<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>entity <span class="token operator">=></span> entity<span class="token punctuation">.</span><span class="token function">HasMany</span><span class="token punctuation">(</span>e <span class="token operator">=></span> e<span class="token punctuation">.</span>Users<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> uu <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">User</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* .. */</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span>Users<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>u <span class="token operator">=></span> u<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>uu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span>Tenants<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>t <span class="token operator">=></span> t<span class="token punctuation">.</span>Users<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>uu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ­¤æ—¶ <code>queryExecutor</code> æ˜¯è¿™æ ·çš„ï¼š</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp">queryContext<span class="token punctuation">.</span><span class="token function">AddParameter</span><span class="token punctuation">(</span>
    <span class="token string">"__entity_equality_uu_0_Id"</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Func<span class="token punctuation">&lt;</span>QueryContext<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">?</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>
        queryContext <span class="token operator">=></span> <span class="token function">ParameterValueExtractor</span><span class="token punctuation">(</span>queryContext<span class="token punctuation">,</span> <span class="token string">"__uu_0"</span><span class="token punctuation">,</span> IProperty<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>queryContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SingleQueryingEnumerable<span class="token punctuation">&lt;</span>User<span class="token punctuation">></span></span><span class="token punctuation">(</span>
    <span class="token named-parameter punctuation">relationalQueryContext</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>RelationalQueryContext<span class="token punctuation">)</span>queryContext<span class="token punctuation">,</span>
    <span class="token named-parameter punctuation">relationalCommandCache</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span>RelationalCommandCache<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token named-parameter punctuation">shaper</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span>Func<span class="token operator">&lt;</span>QueryContext<span class="token punctuation">,</span> DbDataReader<span class="token punctuation">,</span> ResultContext<span class="token punctuation">,</span> SingleQueryResultCoordinator<span class="token punctuation">,</span> User<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token named-parameter punctuation">contextType</span><span class="token punctuation">:</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">MyContext</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token named-parameter punctuation">standAloneStateManager</span><span class="token punctuation">:</span> False<span class="token punctuation">,</span>
    <span class="token named-parameter punctuation">detailedErrorsEnabled</span><span class="token punctuation">:</span> False<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€è°“â€œè¿è¡Œæ—¶å‚æ•°â€æ˜¯ SQL è¯­å¥æ‰§è¡Œæ—¶çš„å‚æ•°ï¼Œä½†æ˜¯ï¼Œè¦æƒ³è¯»å–å®ƒçš„å€¼ï¼Œå°±éœ€è¦åè¿‡æ¥ä» <code>QueryContext</code> ä¸­è¯»å–ã€‚ä¸ºä»€ä¹ˆä¼šåœ¨ <code>QueryContext</code> ä¸­å‘¢ï¼Ÿå› ä¸ºä¹‹å‰ <code>QueryCompiler.ExtractParameters</code> çš„æ—¶å€™ï¼Œè¿™ä¸ªå¯¹è±¡çš„æ•´ä½“è¢«åŠ å…¥äº† <code>QueryContext</code> ä¸­ï¼Œè€Œä¸æ˜¯è¢«ç›´æ¥è®¡ç®—å¥½ã€‚å¯¹äºéœ€è¦åˆ¤æ–­å®ä½“åŒ…å«å’Œå®ä½“ç›¸ç­‰çš„æƒ…å†µï¼Œå°±éœ€è¦ç”¨åˆ°è¿™ç§å¥‡æ€ªçš„æ–¹æ³•ã€‚</p>
<p>ç°åœ¨é—®é¢˜æ¥äº†ï¼š<code>relationalCommandCache</code> å’Œ <code>shaper</code> æ˜¯åœ¨ä½•æ—¶æ„å»ºå¥½çš„ï¼Ÿ</p>
<p>å‰è€…ä¿å­˜ç€ç¿»è¯‘å®Œæˆçš„ SQL è¡¨è¾¾å¼æ ‘çš„å¯¹è±¡ï¼Œä»–ä¼šåœ¨åˆ›å»º <code>DbCommand</code> å¯¹è±¡çš„æ—¶å€™ï¼Œè°ƒç”¨ <code>QuerySqlGenerator</code> å°†è¡¨è¾¾å¼æ ‘æ‹å¹³æˆä¸º SQL è¯­å¥æ–‡æœ¬ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬æ¥ç ”ç©¶ä¸€ä¸‹åè€…è¿™ä¸ª <code>shaper</code> å§”æ‰˜ã€‚</p>
<p>è¿™ä¸ªå§”æ‰˜ä¹Ÿæ˜¯ç”± EFCore åŠ¨æ€åˆ›å»ºçš„ï¼Œä½†æ˜¯è¿™ä¸ªå§”æ‰˜çš„å…·ä½“å®ç°æ˜¯å’Œæ•°æ®åº“ç±»å‹æœ‰å…³ç³»çš„ã€‚åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œç”± <code>RelationalShapedQueryCompilingExpressionVisitor</code> è¿›è¡Œåˆ›å»ºã€‚</p>
<p>å¯¹äºåˆšæ‰ç›´æ¥æ‹¿åˆ°å®ä½“çš„æƒ…å†µï¼Œå®ƒäº§ç”Ÿçš„ä»£ç æ˜¯è¿™æ ·çš„</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// SELECT [u].[Id], [u].[Name], [u].[RegisterTime], [u].[TenantId]</span>
<span class="token comment">// FROM [Users] AS [u]</span>

<span class="token return-type class-name">User</span> <span class="token function">Shape</span><span class="token punctuation">(</span><span class="token class-name">QueryContext</span> queryContext<span class="token punctuation">,</span> <span class="token class-name">DbDataReader</span> dataReader<span class="token punctuation">,</span> <span class="token class-name">ResultContext</span> resultContext<span class="token punctuation">,</span> <span class="token class-name">SingleQueryResultCoordinator</span> resultCoordinator<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">User</span> var1 <span class="token operator">=</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">IEntityType</span> entityType1<span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> materializationContext1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MaterializationContext</span><span class="token punctuation">(</span>
            <span class="token named-parameter punctuation">valueBuffer</span><span class="token punctuation">:</span> ValueBuffer<span class="token punctuation">.</span>Empty<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">context</span><span class="token punctuation">:</span> queryContext<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">User</span> instance1 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token class-name">InternalEntityEntry</span> entry1 <span class="token operator">=</span> queryContext<span class="token punctuation">.</span><span class="token function">TryGetEntry</span><span class="token punctuation">(</span>
            <span class="token named-parameter punctuation">key</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">IKey</span><span class="token punctuation">:</span> <span class="token string">"Key: User.Id PK"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">keyValues</span><span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">throwOnNullKey</span><span class="token punctuation">:</span> True<span class="token punctuation">,</span>
            <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">bool</span></span> hasNullKey1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasNullKey1<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry1 <span class="token operator">!=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">InternalEntityEntry</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                entityType1 <span class="token operator">=</span> entry1<span class="token punctuation">.</span>EntityType<span class="token punctuation">;</span>
                instance1 <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">)</span>entry1<span class="token punctuation">.</span>Entity<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name">ValueBuffer</span> shadowValueBuffer1 <span class="token operator">=</span> ValueBuffer<span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
                entityType1 <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">"EntityType: User"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                instance1 <span class="token operator">=</span> entityType1 <span class="token keyword">switch</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">"EntityType: User"</span><span class="token punctuation">)</span> <span class="token operator">=></span>
                    <span class="token punctuation">&#123;</span>
                        <span class="token comment">// EFCoreç”Ÿæˆçš„shadow propertyï¼Œæ­¤å¤„ä¸º int? TenantId</span>
                        shadowValueBuffer1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ValueBuffer</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
                        <span class="token punctuation">&#123;</span>
                            dataReader<span class="token punctuation">.</span><span class="token function">IsDBNull</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">?</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword">object</span></span><span class="token punctuation">)</span> <span class="token punctuation">:</span> dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
                        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token class-name">User</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        instance<span class="token punctuation">.</span><span class="token operator">&lt;</span>Id<span class="token operator">></span>k__BackingField <span class="token operator">=</span> dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        instance<span class="token punctuation">.</span><span class="token operator">&lt;</span>Name<span class="token operator">></span>k__BackingField <span class="token operator">=</span> dataReader<span class="token punctuation">.</span><span class="token function">IsDBNull</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                            <span class="token punctuation">?</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword">string</span></span><span class="token punctuation">)</span>
                            <span class="token punctuation">:</span> dataReader<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        instance<span class="token punctuation">.</span><span class="token operator">&lt;</span>RegisterTime<span class="token operator">></span>k__BackingField <span class="token operator">=</span> dataReader<span class="token punctuation">.</span><span class="token function">GetFieldValue</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        block<span class="token operator">-</span><span class="token keyword">return</span> instance<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                    _ <span class="token operator">=></span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

                entry1 <span class="token operator">=</span> entityType1 <span class="token operator">==</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">IEntityType</span><span class="token punctuation">)</span>
                    <span class="token punctuation">?</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">InternalEntityEntry</span><span class="token punctuation">)</span>
                    <span class="token punctuation">:</span> queryContext<span class="token punctuation">.</span><span class="token function">StartTracking</span><span class="token punctuation">(</span>entityType1<span class="token punctuation">,</span> instance1<span class="token punctuation">,</span> shadowValueBuffer1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        block<span class="token operator">-</span><span class="token keyword">return</span> instance1<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> var1<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ³¨æ„æ­¤å¤„æ‘†å‡ºçš„ä»£ç æ˜¯ä» EFCore ç”Ÿæˆçš„è¡¨è¾¾å¼æ ‘æ”¹å†™è€Œæ¥ï¼Œä¸åŸæ¥çš„è¡¨è¾¾å¼æ ‘å¹¶ä¸å®Œå…¨ç›¸åŒï¼ŒåŸæ¥çš„ä¸€äº›å†™æ³•åœ¨ C# ä¸­æ— æ³•ç›´æ¥è¡¨è¾¾ï¼ˆä¾‹å¦‚ kotlin é‚£æ ·ï¼Œä¸€å¯¹èŠ±æ‹¬å·æœ€åä¸€ä¸ªå€¼ä½œä¸ºæ•´ä¸ªèŠ±æ‹¬å·çš„å€¼ï¼Œæ­¤å¤„ç”¨ <code>block-return</code> è¡¨ç¤ºï¼›ä»¥åŠ <code>default(void)</code> ä½œä¸ºä¸‰å…ƒè¡¨è¾¾å¼å€¼çš„ä½¿ç”¨ï¼‰ï¼Œæ‰€ä»¥ç¨æœ‰æ”¹å†™ã€‚</p>
<p>æ‰”ä»£ç å‡ºæ¥ä¸æ˜¯è®©å¤§å®¶çœ‹æ‡‚ï¼Œè€Œæ˜¯è®©å¤§å®¶ä½“ä¼šä¸€ä¸‹ã€‚Donâ€™t try to understand it, feel it.</p>
<p>å¯ä»¥çœ‹åˆ°å¤§è‡´çš„å®ä½“ç”Ÿæˆè¿‡ç¨‹ï¼Œä»¥åŠå®ä½“è·Ÿè¸ªçš„æµç¨‹ï¼šå…ˆçœ‹ä¸Šä¸‹æ–‡æ˜¯å¦å·²ç»è¿½è¸ªäº†è¿™æ ·çš„å®ä½“ï¼Œæœ‰åˆ™ç›´æ¥ä½¿ç”¨ï¼Œæ— åˆ™è·³è¿‡ã€‚</p>
<p>è€Œ <code>switch</code> åˆ™æ˜¯ç»™å®ä½“ç»§æ‰¿å…³ç³»åšå‡ºçš„è®¾è®¡ã€‚åœ¨æœ‰å®ä½“ç»§æ‰¿çš„æƒ…å†µä¸‹ï¼Œ<code>entityType1</code> çš„å€¼æ˜¯é€šè¿‡è¯»å–æŸ¥è¯¢ç»“æœæŸä¸ª Shadow Property å­—æ®µæ¥ç¡®å®šçš„ã€‚</p>
<p>å¦‚æœä½¿ç”¨ <code>AsNoTracking</code> æ ‡è®°æŸ¥è¯¢å‘¢ï¼Ÿ</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// SELECT [u].[Id], [u].[Name], [u].[RegisterTime], [u].[TenantId]</span>
<span class="token comment">// FROM [Users] AS [u]</span>

<span class="token return-type class-name">User</span> <span class="token function">Shape</span><span class="token punctuation">(</span><span class="token class-name">QueryContext</span> queryContext<span class="token punctuation">,</span> <span class="token class-name">DbDataReader</span> dataReader<span class="token punctuation">,</span> <span class="token class-name">ResultContext</span> resultContext<span class="token punctuation">,</span> <span class="token class-name">SingleQueryResultCoordinator</span> resultCoordinator<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">User</span> var1 <span class="token operator">=</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">IEntityType</span> entityType1<span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> materializationContext1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MaterializationContext</span><span class="token punctuation">(</span>
            <span class="token named-parameter punctuation">valueBuffer</span><span class="token punctuation">:</span> ValueBuffer<span class="token punctuation">.</span>Empty<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">context</span><span class="token punctuation">:</span> queryContext<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">User</span> instance1 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">object</span><span class="token punctuation">)</span>dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name">ValueBuffer</span> shadowValueBuffer1 <span class="token operator">=</span> ValueBuffer<span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
            entityType1 <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">"EntityType: User"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            instance1 <span class="token operator">=</span> entityType1 <span class="token keyword">switch</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">"EntityType: User"</span><span class="token punctuation">)</span> <span class="token operator">=></span>
                <span class="token punctuation">&#123;</span>
                    <span class="token class-name">User</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    instance<span class="token punctuation">.</span><span class="token operator">&lt;</span>Id<span class="token operator">></span>k__BackingField <span class="token operator">=</span> dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    instance<span class="token punctuation">.</span><span class="token operator">&lt;</span>Name<span class="token operator">></span>k__BackingField <span class="token operator">=</span> dataReader<span class="token punctuation">.</span><span class="token function">IsDBNull</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                        <span class="token punctuation">?</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword">string</span></span><span class="token punctuation">)</span>
                        <span class="token punctuation">:</span> dataReader<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    instance<span class="token punctuation">.</span><span class="token operator">&lt;</span>RegisterTime<span class="token operator">></span>k__BackingField <span class="token operator">=</span> dataReader<span class="token punctuation">.</span><span class="token function">GetFieldValue</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    block<span class="token operator">-</span><span class="token keyword">return</span> instance<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                _ <span class="token operator">=></span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        block<span class="token operator">-</span><span class="token keyword">return</span> instance1<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> var1<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå®ä½“è·Ÿè¸ªç›¸å…³çš„ä»£ç æ²¡äº†ï¼ŒShadow Property ç›¸å…³çš„ä¹Ÿæ²¡äº†ï¼Œæ¯•ç«Ÿä¸Šä¸‹æ–‡ä¸è¿½è¸ªè¿™ä¸ªå®ä½“ï¼Œæ€ä¹ˆä¼šçŸ¥é“æœ‰å“ªäº›è™šæ‹Ÿå±æ€§å‘¢ã€‚ä¸Šä¸‹æ–‡èƒ½æœ‰ä»€ä¹ˆåå¿ƒæ€å‘¢ã€‚</p>
<p>å¦‚æœæ˜¯æŸ¥è¯¢ä¸­ Select åˆ›å»ºäº†ä¸€ä¸ªéå®ä½“ç±»å‹å‘¢ï¼Ÿï¼ˆè¿™é‡Œå…¶å®å’Œ <code>.Count()</code>ã€<code>.Sum()</code> ä¹‹ç±»çš„å‡½æ•°æ•ˆæœå·®ä¸å¤šï¼‰</p>
<p>ä¾‹å¦‚ <code>context.Users.Select(u =&gt; new UserDto(u.Id, u.Name, false)).ToList();</code>ã€‚</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// SELECT [u].[Id], [u].[Name]</span>
<span class="token comment">// FROM [Users] AS [u]</span>

<span class="token return-type class-name">UserDto</span> <span class="token function">Shape</span><span class="token punctuation">(</span><span class="token class-name">QueryContext</span> queryContext<span class="token punctuation">,</span> <span class="token class-name">DbDataReader</span> dataReader<span class="token punctuation">,</span> <span class="token class-name">ResultContext</span> resultContext<span class="token punctuation">,</span> <span class="token class-name">SingleQueryResultCoordinator</span> resultCoordinator<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> param0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">?</span><span class="token punctuation">)</span>dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> param1 <span class="token operator">=</span> dataReader<span class="token punctuation">.</span><span class="token function">IsDBNull</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">?</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">:</span> dataReader<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UserDto</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>param0<span class="token punctuation">,</span> param1<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å—¯ï¼Œç”šè‡³ç›´æ¥è·³è¿‡äº† <code>IEntityType</code> çš„æ£€æŸ¥â€¦â€¦ä¸è¿‡ä¹Ÿæ­£å¸¸ï¼Œæ¯•ç«Ÿè¿™é‡Œæ²¡æœ‰ä¸€ä¸ªå®ä½“å¯¹åº”å¤šç§ CLR ç±»å‹çš„çŠ¶å†µã€‚</p>
<p>å†æ¥ä¸€ä¸ªä½¿ç”¨äº†å•ä¸ªå®ä½“ Include çš„å§ã€‚ä»¥ <code>context.Users.Include(u =&gt; u.Tenant).ToListAsync()</code> ä¸ºä¾‹</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// SELECT [u].[Id], [u].[Name], [u].[RegisterTime], [u].[TenantId], [t].[Id]</span>
<span class="token comment">// FROM [Users] AS [u]</span>
<span class="token comment">// LEFT JOIN [Tenants] AS [t] ON [u].[TenantId] = [t].[Id]</span>

<span class="token return-type class-name">User</span> <span class="token function">Shape</span><span class="token punctuation">(</span><span class="token class-name">QueryContext</span> queryContext<span class="token punctuation">,</span> <span class="token class-name">DbDataReader</span> dataReader<span class="token punctuation">,</span> <span class="token class-name">ResultContext</span> resultContext<span class="token punctuation">,</span> <span class="token class-name">SingleQueryResultCoordinator</span> resultCoordinator<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">User</span> var1 <span class="token operator">=</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">IEntityType</span> entityType1<span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> materializationContext1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MaterializationContext</span><span class="token punctuation">(</span>
            <span class="token named-parameter punctuation">valueBuffer</span><span class="token punctuation">:</span> ValueBuffer<span class="token punctuation">.</span>Empty<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">context</span><span class="token punctuation">:</span> queryContext<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">User</span> instance1 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token class-name">InternalEntityEntry</span> entry1 <span class="token operator">=</span> queryContext<span class="token punctuation">.</span><span class="token function">TryGetEntry</span><span class="token punctuation">(</span>
            <span class="token named-parameter punctuation">key</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">IKey</span><span class="token punctuation">:</span> <span class="token string">"Key: User.Id PK"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">keyValues</span><span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">throwOnNullKey</span><span class="token punctuation">:</span> True<span class="token punctuation">,</span>
            <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">bool</span></span> hasNullKey1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasNullKey1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span> <span class="token comment">// æ­¤å¤„ä¸ä¸Šè¿°å¸¦ Tracking çš„ç±»ä¼¼</span>
        block<span class="token operator">-</span><span class="token keyword">return</span> instance1<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token class-name">Tenant</span> var2 <span class="token operator">=</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">IEntityType</span> entityType2<span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> materializationContext2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MaterializationContext</span><span class="token punctuation">(</span>
            <span class="token named-parameter punctuation">valueBuffer</span><span class="token punctuation">:</span> ValueBuffer<span class="token punctuation">.</span>Empty<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">context</span><span class="token punctuation">:</span> queryContext<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Tenant</span> instance2 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token class-name">InternalEntityEntry</span> entry2 <span class="token operator">=</span> queryContext<span class="token punctuation">.</span><span class="token function">TryGetEntry</span><span class="token punctuation">(</span>
            <span class="token named-parameter punctuation">key</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">IKey</span><span class="token punctuation">:</span> <span class="token string">"Key: Tenant.Id PK"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">keyValues</span><span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> dataReader<span class="token punctuation">.</span><span class="token function">IsDBNull</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">?</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword">object</span></span><span class="token punctuation">)</span> <span class="token punctuation">:</span> dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">throwOnNullKey</span><span class="token punctuation">:</span> False<span class="token punctuation">,</span>
            <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">bool</span></span> hasNullKey2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasNullKey2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span> <span class="token comment">// æ­¤å¤„ä¸ä¸Šè¿°å¸¦ Tracking çš„ç±»ä¼¼</span>
        block<span class="token operator">-</span><span class="token keyword">return</span> instance2<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token function">IncludeReference</span><span class="token punctuation">(</span>
        <span class="token named-parameter punctuation">queryContext</span><span class="token punctuation">:</span> queryContext<span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">entity</span><span class="token punctuation">:</span> var1<span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">relatedEntity</span><span class="token punctuation">:</span> var2<span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">navigation</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">"Navigation: User.Tenant (Tenant) ToPrincipal Tenant Inverse: Users"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">inverseNavigation</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">"Navigation: Tenant.Users (ICollection&lt;User>) Collection ToDependent User Inverse: Tenant"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">fixup</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>entity<span class="token punctuation">,</span> relatedEntity<span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token punctuation">&#123;</span>
            entity<span class="token punctuation">.</span><span class="token operator">&lt;</span>Tenant<span class="token operator">></span>k__BackingField <span class="token operator">=</span> relatedEntity<span class="token punctuation">;</span>
            <span class="token comment">// value(ClrICollectionAccessor&lt;Tenant, ICollection&lt;User>, User>) = inverseNavigation.GetCollectionAccessor()</span>
            <span class="token keyword">value</span><span class="token punctuation">(</span>IClrICollectionAccessor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>relatedEntity<span class="token punctuation">,</span> entity<span class="token punctuation">,</span> <span class="token named-parameter punctuation">forMaterialization</span><span class="token punctuation">:</span> True<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">trackingQuery</span><span class="token punctuation">:</span> True<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> var1<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">// Microsoft.EntityFrameworkCore.Query.RelationalShapedQueryCompilingExpressionVisitor+ShaperProcessingExpressionVisitor</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">IncludeReference</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">,</span> TIncludingEntity<span class="token punctuation">,</span> TIncludedEntity<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
    <span class="token class-name">QueryContext</span> queryContext<span class="token punctuation">,</span>
    <span class="token class-name">TEntity</span> entity<span class="token punctuation">,</span>
    <span class="token class-name">TIncludedEntity</span> relatedEntity<span class="token punctuation">,</span>
    <span class="token class-name">INavigationBase</span> navigation<span class="token punctuation">,</span>
    <span class="token class-name">INavigationBase</span> inverseNavigation<span class="token punctuation">,</span>
    <span class="token class-name">Action<span class="token punctuation">&lt;</span>TIncludingEntity<span class="token punctuation">,</span> TIncludedEntity<span class="token punctuation">></span></span> fixup<span class="token punctuation">,</span>
    <span class="token class-name"><span class="token keyword">bool</span></span> trackingQuery<span class="token punctuation">)</span>
    <span class="token keyword">where</span> <span class="token class-name">TEntity</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
    <span class="token keyword">where</span> <span class="token class-name">TIncludingEntity</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">TEntity</span></span>
    <span class="token keyword">where</span> <span class="token class-name">TIncludedEntity</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entity <span class="token keyword">is</span> <span class="token class-name">TIncludingEntity</span> includingEntity<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>trackingQuery
            <span class="token operator">&amp;&amp;</span> navigation<span class="token punctuation">.</span>DeclaringEntityType<span class="token punctuation">.</span><span class="token function">FindPrimaryKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// For non-null relatedEntity StateManager will set the flag</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>relatedEntity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                queryContext<span class="token punctuation">.</span><span class="token function">SetNavigationIsLoaded</span><span class="token punctuation">(</span>includingEntity<span class="token punctuation">,</span> navigation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            navigation<span class="token punctuation">.</span><span class="token function">SetIsLoadedWhenNoTracking</span><span class="token punctuation">(</span>includingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>relatedEntity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token function">fixup</span><span class="token punctuation">(</span>includingEntity<span class="token punctuation">,</span> relatedEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>inverseNavigation <span class="token operator">!=</span> <span class="token keyword">null</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inverseNavigation<span class="token punctuation">.</span>IsCollection<span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    inverseNavigation<span class="token punctuation">.</span><span class="token function">SetIsLoadedWhenNoTracking</span><span class="token punctuation">(</span>relatedEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å†æ¥ä¸€ä¸ªé›†åˆ Include çš„å§ã€‚é›†åˆçš„ç‰¹åˆ«å¤æ‚ã€‚</p>
<p>ä»¥ <code>context.Tenants.Include(t =&gt; t.Users).ToListAsync()</code> ä¸ºä¾‹</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// SELECT [t].[Id], [u].[Id], [u].[Name], [u].[RegisterTime], [u].[TenantId]</span>
<span class="token comment">// FROM [Tenants] AS [t]</span>
<span class="token comment">// LEFT JOIN [Users] AS [u] ON [t].[Id] = [u].[TenantId]</span>
<span class="token comment">// ORDER BY [t].[Id], [u].[Id]</span>

<span class="token return-type class-name">Tenant</span> <span class="token function">Shape</span><span class="token punctuation">(</span><span class="token class-name">QueryContext</span> queryContext<span class="token punctuation">,</span> <span class="token class-name">DbDataReader</span> dataReader<span class="token punctuation">,</span> <span class="token class-name">ResultContext</span> resultContext<span class="token punctuation">,</span> <span class="token class-name">SingleQueryResultCoordinator</span> resultCoordinator<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resultContext<span class="token punctuation">.</span>Values <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">Tenant</span> var1 <span class="token operator">=</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> materializationContext1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MaterializationContext</span><span class="token punctuation">(</span>
                <span class="token named-parameter punctuation">valueBuffer</span><span class="token punctuation">:</span> ValueBuffer<span class="token punctuation">.</span>Empty<span class="token punctuation">,</span>
                <span class="token named-parameter punctuation">context</span><span class="token punctuation">:</span> queryContext<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Tenant</span> instance1 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token class-name">InternalEntityEntry</span> entry1 <span class="token operator">=</span> queryContext<span class="token punctuation">.</span><span class="token function">TryGetEntry</span><span class="token punctuation">(</span>
                <span class="token named-parameter punctuation">key</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">IKey</span><span class="token punctuation">:</span> <span class="token string">"Key: Tenant.Id PK"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token named-parameter punctuation">keyValues</span><span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token named-parameter punctuation">throwOnNullKey</span><span class="token punctuation">:</span> True<span class="token punctuation">,</span>
                <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">bool</span></span> hasNullKey1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasNullKey1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span> <span class="token comment">// æ­¤å¤„ä¸ä¸Šè¿°å¸¦ Tracking çš„ç±»ä¼¼</span>
            block<span class="token operator">-</span><span class="token keyword">return</span> instance1<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        resultContext<span class="token punctuation">.</span>Values <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> var1 <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token function">InitializeIncludeCollection</span><span class="token punctuation">(</span>
            <span class="token named-parameter punctuation">collectionId</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">queryContext</span><span class="token punctuation">:</span> queryContext<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">dbDataReader</span><span class="token punctuation">:</span> dataReader<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">resultCoordinator</span><span class="token punctuation">:</span> resultCoordinator<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">entity</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>Tenant<span class="token punctuation">)</span>resultContext<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">parentIdentifier</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>queryContext<span class="token punctuation">,</span> dataReader<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">?</span><span class="token punctuation">)</span>dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">outerIdentifier</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>queryContext<span class="token punctuation">,</span> dataReader<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">?</span><span class="token punctuation">)</span>dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">navigation</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">"Navigation: Tenant.Users (ICollection&lt;User>) Collection ToDependent User Inverse: Tenant"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">clrCollectionAccessor</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span>ClrCollectionAccessor<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">trackingQuery</span><span class="token punctuation">:</span> True<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">PopulateIncludeCollection</span><span class="token punctuation">(</span>
        <span class="token named-parameter punctuation">collectionId</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">queryContext</span><span class="token punctuation">:</span> queryContext<span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">dbDataReader</span><span class="token punctuation">:</span> dataReader<span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">resultCoordinator</span><span class="token punctuation">:</span> resultCoordinator<span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">parentIdentifier</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>queryContext<span class="token punctuation">,</span> dataReader<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">?</span><span class="token punctuation">)</span>dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">outerIdentifier</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>queryContext<span class="token punctuation">,</span> dataReader<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">?</span><span class="token punctuation">)</span>dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">selfIdentifier</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>queryContext<span class="token punctuation">,</span> dataReader<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> dataReader<span class="token punctuation">.</span><span class="token function">IsDBNull</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">?</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword">int</span><span class="token punctuation">?</span></span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">?</span><span class="token punctuation">)</span>dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">parentIdentifierValueComparers</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span>IReadOnlyList<span class="token operator">&lt;</span>ValueComparer<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">outerIdentifierValueComparers</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span>IReadOnlyList<span class="token operator">&lt;</span>ValueComparer<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">selfIdentifierValueComparers</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span>IReadOnlyList<span class="token operator">&lt;</span>ValueComparer<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">innerShaper</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>queryContext<span class="token punctuation">,</span> dataReader<span class="token punctuation">,</span> resultContext<span class="token punctuation">,</span> resultCoordinator<span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name">User</span> var1 <span class="token operator">=</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> materializationContext2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MaterializationContext</span><span class="token punctuation">(</span>
                    <span class="token named-parameter punctuation">valueBuffer</span><span class="token punctuation">:</span> ValueBuffer<span class="token punctuation">.</span>Empty<span class="token punctuation">,</span>
                    <span class="token named-parameter punctuation">context</span><span class="token punctuation">:</span> queryContext<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">User</span> instance2 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

                <span class="token class-name">InternalEntityEntry</span> entry2 <span class="token operator">=</span> queryContext<span class="token punctuation">.</span><span class="token function">TryGetEntry</span><span class="token punctuation">(</span>
                    <span class="token named-parameter punctuation">key</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">IKey</span><span class="token punctuation">:</span> <span class="token string">"Key: User.Id PK"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token named-parameter punctuation">keyValues</span><span class="token punctuation">:</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> dataReader<span class="token punctuation">.</span><span class="token function">IsDBNull</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">?</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword">object</span></span><span class="token punctuation">)</span> <span class="token punctuation">:</span> dataReader<span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                    <span class="token named-parameter punctuation">throwOnNullKey</span><span class="token punctuation">:</span> False<span class="token punctuation">,</span>
                    <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">bool</span></span> hasNullKey2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasNullKey2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span> <span class="token comment">// æ­¤å¤„ä¸ä¸Šè¿°å¸¦ Tracking çš„ç±»ä¼¼</span>
                block<span class="token operator">-</span><span class="token keyword">return</span> instance2<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> var1<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">inverseNavigation</span><span class="token punctuation">:</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">"Navigation: User.Tenant (Tenant) ToPrincipal Tenant Inverse: Users"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">fixup</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">Tenant</span> including<span class="token punctuation">,</span> <span class="token class-name">User</span> included<span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">value</span><span class="token punctuation">(</span>IClrICollectionAccessor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>including<span class="token punctuation">,</span> included<span class="token punctuation">,</span> True<span class="token punctuation">)</span><span class="token punctuation">;</span>
            included<span class="token punctuation">.</span><span class="token operator">&lt;</span>Tenant<span class="token operator">></span>k__BackingField <span class="token operator">=</span> including<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">trackingQuery</span><span class="token punctuation">:</span> True<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> resultCoordinator<span class="token punctuation">.</span>ResultReady
        <span class="token punctuation">?</span> <span class="token punctuation">(</span>Tenant<span class="token punctuation">)</span>resultContext<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token punctuation">:</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">Tenant</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">// Microsoft.EntityFrameworkCore.Query.RelationalShapedQueryCompilingExpressionVisitor+ShaperProcessingExpressionVisitor</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">InitializeIncludeCollection</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TParent<span class="token punctuation">,</span> TNavigationEntity<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
    <span class="token class-name"><span class="token keyword">int</span></span> collectionId<span class="token punctuation">,</span>
    <span class="token class-name">QueryContext</span> queryContext<span class="token punctuation">,</span>
    <span class="token class-name">DbDataReader</span> dbDataReader<span class="token punctuation">,</span>
    <span class="token class-name">SingleQueryResultCoordinator</span> resultCoordinator<span class="token punctuation">,</span>
    <span class="token class-name">TParent</span> entity<span class="token punctuation">,</span>
    <span class="token class-name">Func<span class="token punctuation">&lt;</span>QueryContext<span class="token punctuation">,</span> DbDataReader<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">></span></span> parentIdentifier<span class="token punctuation">,</span>
    <span class="token class-name">Func<span class="token punctuation">&lt;</span>QueryContext<span class="token punctuation">,</span> DbDataReader<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">></span></span> outerIdentifier<span class="token punctuation">,</span>
    <span class="token class-name">INavigationBase</span> navigation<span class="token punctuation">,</span>
    <span class="token class-name">IClrCollectionAccessor</span> clrCollectionAccessor<span class="token punctuation">,</span>
    <span class="token class-name"><span class="token keyword">bool</span></span> trackingQuery<span class="token punctuation">)</span>
    <span class="token keyword">where</span> <span class="token class-name">TParent</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
    <span class="token keyword">where</span> <span class="token class-name">TNavigationEntity</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">TParent</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">object</span></span> collection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entity <span class="token keyword">is</span> <span class="token class-name">TNavigationEntity</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>trackingQuery<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            queryContext<span class="token punctuation">.</span><span class="token function">SetNavigationIsLoaded</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> navigation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            navigation<span class="token punctuation">.</span><span class="token function">SetIsLoadedWhenNoTracking</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        collection <span class="token operator">=</span> clrCollectionAccessor<span class="token punctuation">.</span><span class="token function">GetOrCreate</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> <span class="token named-parameter punctuation">forMaterialization</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> parentKey <span class="token operator">=</span> <span class="token function">parentIdentifier</span><span class="token punctuation">(</span>queryContext<span class="token punctuation">,</span> dbDataReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> outerKey <span class="token operator">=</span> <span class="token function">outerIdentifier</span><span class="token punctuation">(</span>queryContext<span class="token punctuation">,</span> dbDataReader<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> collectionMaterializationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SingleQueryCollectionContext</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> collection<span class="token punctuation">,</span> parentKey<span class="token punctuation">,</span> outerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

    resultCoordinator<span class="token punctuation">.</span><span class="token function">SetSingleQueryCollectionContext</span><span class="token punctuation">(</span>collectionId<span class="token punctuation">,</span> collectionMaterializationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Microsoft.EntityFrameworkCore.Query.RelationalShapedQueryCompilingExpressionVisitor+ShaperProcessingExpressionVisitor</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">PopulateIncludeCollection</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TIncludingEntity<span class="token punctuation">,</span> TIncludedEntity<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
    <span class="token class-name"><span class="token keyword">int</span></span> collectionId<span class="token punctuation">,</span>
    <span class="token class-name">QueryContext</span> queryContext<span class="token punctuation">,</span>
    <span class="token class-name">DbDataReader</span> dbDataReader<span class="token punctuation">,</span>
    <span class="token class-name">SingleQueryResultCoordinator</span> resultCoordinator<span class="token punctuation">,</span>
    <span class="token class-name">Func<span class="token punctuation">&lt;</span>QueryContext<span class="token punctuation">,</span> DbDataReader<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">></span></span> parentIdentifier<span class="token punctuation">,</span>
    <span class="token class-name">Func<span class="token punctuation">&lt;</span>QueryContext<span class="token punctuation">,</span> DbDataReader<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">></span></span> outerIdentifier<span class="token punctuation">,</span>
    <span class="token class-name">Func<span class="token punctuation">&lt;</span>QueryContext<span class="token punctuation">,</span> DbDataReader<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">></span></span> selfIdentifier<span class="token punctuation">,</span>
    <span class="token class-name">IReadOnlyList<span class="token punctuation">&lt;</span>ValueComparer<span class="token punctuation">></span></span> parentIdentifierValueComparers<span class="token punctuation">,</span>
    <span class="token class-name">IReadOnlyList<span class="token punctuation">&lt;</span>ValueComparer<span class="token punctuation">></span></span> outerIdentifierValueComparers<span class="token punctuation">,</span>
    <span class="token class-name">IReadOnlyList<span class="token punctuation">&lt;</span>ValueComparer<span class="token punctuation">></span></span> selfIdentifierValueComparers<span class="token punctuation">,</span>
    <span class="token class-name">Func<span class="token punctuation">&lt;</span>QueryContext<span class="token punctuation">,</span> DbDataReader<span class="token punctuation">,</span> ResultContext<span class="token punctuation">,</span> SingleQueryResultCoordinator<span class="token punctuation">,</span> TIncludedEntity<span class="token punctuation">></span></span> innerShaper<span class="token punctuation">,</span>
    <span class="token class-name">INavigationBase</span> inverseNavigation<span class="token punctuation">,</span>
    <span class="token class-name">Action<span class="token punctuation">&lt;</span>TIncludingEntity<span class="token punctuation">,</span> TIncludedEntity<span class="token punctuation">></span></span> fixup<span class="token punctuation">,</span>
    <span class="token class-name"><span class="token keyword">bool</span></span> trackingQuery<span class="token punctuation">)</span>
    <span class="token keyword">where</span> <span class="token class-name">TIncludingEntity</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
    <span class="token keyword">where</span> <span class="token class-name">TIncludedEntity</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> collectionMaterializationContext <span class="token operator">=</span> resultCoordinator<span class="token punctuation">.</span>Collections<span class="token punctuation">[</span>collectionId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>collectionMaterializationContext<span class="token punctuation">.</span>Parent <span class="token keyword">is</span> <span class="token class-name">TIncludingEntity</span> entity<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultCoordinator<span class="token punctuation">.</span>HasNext <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// Outer Enumerator has ended</span>
            <span class="token function">GenerateCurrentElementIfPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CompareIdentifiers</span><span class="token punctuation">(</span>
            outerIdentifierValueComparers<span class="token punctuation">,</span>
            <span class="token function">outerIdentifier</span><span class="token punctuation">(</span>queryContext<span class="token punctuation">,</span> dbDataReader<span class="token punctuation">)</span><span class="token punctuation">,</span> collectionMaterializationContext<span class="token punctuation">.</span>OuterIdentifier<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// Outer changed so collection has ended. Materialize last element.</span>
            <span class="token function">GenerateCurrentElementIfPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// If parent also changed then this row is now pointing to element of next collection</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CompareIdentifiers</span><span class="token punctuation">(</span>
                parentIdentifierValueComparers<span class="token punctuation">,</span>
                <span class="token function">parentIdentifier</span><span class="token punctuation">(</span>queryContext<span class="token punctuation">,</span> dbDataReader<span class="token punctuation">)</span><span class="token punctuation">,</span> collectionMaterializationContext<span class="token punctuation">.</span>ParentIdentifier<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                resultCoordinator<span class="token punctuation">.</span>HasNext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> innerKey <span class="token operator">=</span> <span class="token function">selfIdentifier</span><span class="token punctuation">(</span>queryContext<span class="token punctuation">,</span> dbDataReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>innerKey<span class="token punctuation">.</span><span class="token function">All</span><span class="token punctuation">(</span>e <span class="token operator">=></span> e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// No correlated element</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>collectionMaterializationContext<span class="token punctuation">.</span>SelfIdentifier <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CompareIdentifiers</span><span class="token punctuation">(</span>selfIdentifierValueComparers<span class="token punctuation">,</span> innerKey<span class="token punctuation">,</span> collectionMaterializationContext<span class="token punctuation">.</span>SelfIdentifier<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token comment">// repeated row for current element</span>
                <span class="token comment">// If it is pending materialization then it may have nested elements</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>collectionMaterializationContext<span class="token punctuation">.</span>ResultContext<span class="token punctuation">.</span>Values <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token function">ProcessCurrentElementRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                resultCoordinator<span class="token punctuation">.</span>ResultReady <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// Row for new element which is not first element</span>
            <span class="token comment">// So materialize the element</span>
            <span class="token function">GenerateCurrentElementIfPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            resultCoordinator<span class="token punctuation">.</span>HasNext <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            collectionMaterializationContext<span class="token punctuation">.</span><span class="token function">UpdateSelfIdentifier</span><span class="token punctuation">(</span>innerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// First row for current element</span>
            collectionMaterializationContext<span class="token punctuation">.</span><span class="token function">UpdateSelfIdentifier</span><span class="token punctuation">(</span>innerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token function">ProcessCurrentElementRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultCoordinator<span class="token punctuation">.</span>ResultReady <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ProcessCurrentElementRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> previousResultReady <span class="token operator">=</span> resultCoordinator<span class="token punctuation">.</span>ResultReady<span class="token punctuation">;</span>
        resultCoordinator<span class="token punctuation">.</span>ResultReady <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> relatedEntity <span class="token operator">=</span> <span class="token function">innerShaper</span><span class="token punctuation">(</span>
            queryContext<span class="token punctuation">,</span> dbDataReader<span class="token punctuation">,</span> collectionMaterializationContext<span class="token punctuation">.</span>ResultContext<span class="token punctuation">,</span> resultCoordinator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultCoordinator<span class="token punctuation">.</span>ResultReady<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// related entity is materialized</span>
            collectionMaterializationContext<span class="token punctuation">.</span>ResultContext<span class="token punctuation">.</span>Values <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trackingQuery<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token function">fixup</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> relatedEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>inverseNavigation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    inverseNavigation<span class="token punctuation">.</span><span class="token function">SetIsLoadedWhenNoTracking</span><span class="token punctuation">(</span>relatedEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        resultCoordinator<span class="token punctuation">.</span>ResultReady <span class="token operator">&amp;=</span> previousResultReady<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">GenerateCurrentElementIfPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>collectionMaterializationContext<span class="token punctuation">.</span>ResultContext<span class="token punctuation">.</span>Values <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            resultCoordinator<span class="token punctuation">.</span>HasNext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token function">ProcessCurrentElementRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        collectionMaterializationContext<span class="token punctuation">.</span><span class="token function">UpdateSelfIdentifier</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å—¯ï¼Œè¿™ä»¶äº‹æƒ…å¾ˆç¥å¥‡ã€‚</p>
<p>ç†è®ºä¸Šï¼Œåœ¨ä¸å¸¦è¿‡æ»¤çš„æƒ…å†µä¸‹ï¼ŒOne Include Many å’Œ Many Include One åº”è¯¥æ˜¯ä¸€è‡´çš„ï¼Ÿ</p>
<p>ä¸ºä½•ä»£ç ä¸ºä»€ä¹ˆå·®åˆ«è¿™ä¹ˆå¤§ï¼Ÿå®é™…ä¸Šï¼Œè¿™å°±æ˜¯â€œæŸ¥è¯¢è·Ÿè¸ªâ€çš„ç¥ç§˜ä¹‹å¤„äº†ã€‚</p>
<p>ä¸çŸ¥é“å„ä½æœ‹å‹æ˜¯å¦åœ¨ç½‘ä¸Šçœ‹è§è¿‡è¿™æ ·çš„æ–‡ç« ï¼Œè¯´ä½¿ç”¨ <code>AsNoTracking</code> å¯ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œå¹¶ä¸”è¿˜å»ºè®®å¤§å®¶ç›´æ¥ <code>optionsBuilder.UseQueryTrackingBehavior(NoTracking)</code>ï¼Ÿ</p>
<p>å®é™…ä¸Šï¼Œè¿™æ ·æœ‰ä¸€ç§éšè—çš„å‘ï¼š</p>
<p>å¦‚æœä½ ä½¿ç”¨äº†ä¸€å¯¹å¤šçš„ SQL JOINï¼Œå¹¶ä¸”è¿˜ä¿æŒç€åŸæ¥çš„å®ä½“å½¢çŠ¶ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> results <span class="token operator">=</span> context<span class="token punctuation">.</span>Tenants
    <span class="token punctuation">.</span><span class="token function">AsNoTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>
    	<span class="token named-parameter punctuation">inner</span><span class="token punctuation">:</span> context<span class="token punctuation">.</span>Users<span class="token punctuation">.</span><span class="token function">AsNoTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">outerKeySelector</span><span class="token punctuation">:</span> t <span class="token operator">=></span> t<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">innerKeySelector</span><span class="token punctuation">:</span> u <span class="token operator">=></span> u<span class="token punctuation">.</span>TenantId<span class="token punctuation">,</span>
        <span class="token named-parameter punctuation">resultSelector</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>t<span class="token punctuation">,</span> u<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token punctuation">&#123;</span> t<span class="token punctuation">,</span> u <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‡è®¾ä½ çš„ <code>results[0].t.Id == results[1].t.Id</code>ï¼Œä¹Ÿå°±æ˜¯å‰ä¸¤æ¡åœ¨æ•°æ®åº“ä¸­æ˜¯åŒä¸€ä¸ª <code>t</code> å®ä¾‹ï¼Œå½“ä½ æ‹‰å–åˆ°æœ¬åœ°æ—¶ï¼Œä½ ä¼šå‘ç° <code>object.ReferenceEquals(results[0].t, results[1].t) == false</code>ï¼Œæˆ–è€…è¯´åœ¨æœ¬åœ°ä¸æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Œè€Œä¸¤è€…ä»…ä»…æ˜¯å€¼ç›¸ç­‰ã€‚</p>
<p>å¦‚æœä¸Šè¿°ä»£ç ä½¿ç”¨çš„éƒ½æ˜¯ <code>AsTracking</code>ï¼Œé‚£ä¹ˆ <code>object.ReferenceEquals(results[0].t, results[1].t) == true</code>ï¼Œä»å¤´åˆ°å°¾åªä¼šåˆ›å»ºä¸€ä¸ªè¿™æ ·çš„å®ä½“ã€‚</p>
<p>ä¸ºäº†ä¿è¯ One Include Many åœ¨æœªå¼€å¯å®ä½“è¿½è¸ªçš„æ—¶å€™ä¹Ÿæ­£å¸¸å·¥ä½œï¼Œä¸å¾—ä¸ä½¿ç”¨ä¸€äº›å¥‡æ€ªçš„ä»£ç æ¥ä¿è¯ç»“æœæ­£ç¡®æ€§ã€‚</p>
<p>è¿™ç§æƒ…å†µæ˜¯åœ¨ç¬”è€…ä¸¤å¹´å‰åš JOIN ä»¥åæ‹‰åˆ°æœ¬åœ° GroupBy çš„æ—¶å€™å‘ç°çš„ã€‚å½“å¹´åœ¨å·²ç»å†™äº†å¾ˆå¤šä»£ç ä»¥åæ‰å¼€å¯äº† NoTrackingï¼Œç»“æœå¯¼è‡´å¾ˆå¤šåŸæœ‰åŠŸèƒ½å¤±æ•ˆã€‚ä»é‚£ä¹‹åï¼Œç¬”è€…éƒ½æ˜¯è€è€å®å®å¼€ Tracking çš„ã€‚</p>
<p>å¯¹ï¼Œç¡®å®æœ‰å¾ˆå¤šâ€œä¸å¼€å¯å®ä½“è·Ÿè¸ªâ€è¿˜è¦â€œç”Ÿæˆå‡ºæ¥çš„å®ä½“ä¸é‡å¤â€çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¸‹è¦æ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<p>EFCore 5.0 æ–°æ¨å‡ºäº† <code>NoTrackingWithIdentityResolution</code>ã€‚ç”¨è¿™ä¸ªå°±èƒ½ä¿è¯ä¸Šè¿°çš„å¼•ç”¨ç›¸ç­‰ï¼Œä½†æ˜¯å®ä½“ä¸ä¼šæœ€ç»ˆè¢«ä¸Šä¸‹æ–‡è¿½è¸ªã€‚</p>
<p>å¦å¤–ï¼Œæ‰€è°“â€œä¸å¼€å¯å®ä½“è·Ÿè¸ªâ€æœ€å¤§çš„å½±å“åœºæ™¯ï¼Œæ˜¯æŸ¥è¯¢å¤§é‡æ•°æ®ä»¥åï¼Œå¯¹ä¸Šä¸‹æ–‡è¿›è¡Œå¤šæ¬¡ä¿å­˜æ“ä½œã€‚å¦‚æœä½ è§‰å¾—é¢‘ç¹ä¿å­˜æ—¶å¤„ç†å¤§é‡å®ä½“å˜å¾—å¼‚å¸¸ç¼“æ…¢ï¼Œä½ åº”è¯¥è€ƒè™‘ä¿®æ”¹ <code>DbContext.ChangeTracker.AutoDetectChangesEnabled</code> ä¸º <code>false</code>ï¼Œç„¶åå¯¹æ‰€æœ‰ä¿®æ”¹è¿‡çš„å®ä½“æ‰‹åŠ¨è°ƒç”¨ <code>context.Update</code>ã€‚è¿™æ ·å³ä½¿ä¸Šä¸‹æ–‡è¿½è¸ªä¸Šä¸‡ä¸ªå®ä½“ï¼Œä¿å­˜éƒ½æ˜¯å‡ ä¹ä¸€ç¬é—´çš„äº‹æƒ…ã€‚</p>
<p>å¦å¤–ï¼Œå®ä½“è¿½è¸ªè¿˜æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p>
<p>è®°å¾— <code>IQueryable&lt;&gt;</code> ä»¬çš„ä¸€ä¸ªæ‹“å±• <code>.LoadAsync()</code> å—ï¼Ÿè¿™ä¸ª <code>.LoadAsync()</code>  çš„æ³¨é‡Šè¯´ï¼Œå®ƒçš„åŠŸèƒ½çº¦ç­‰äº <code>.ToListAsync()</code> å¹¶ç«‹é©¬å°†è¿™ä¸ªåˆ—è¡¨æ‰”æ‰ã€‚é‚£æŸ¥è¯¢åˆ°çš„ä¸œè¥¿æ€ä¹ˆåˆ©ç”¨ï¼Ÿä½¿ç”¨ <code>context.Set&lt;MyEntity&gt;().FindAsync(id)</code> å³å¯ã€‚å®ƒä»…åœ¨ <code>id</code> ä¸å­˜åœ¨äºæœ¬åœ°çš„æ—¶å€™æ‰åˆ°æ•°æ®åº“æŸ¥æ‰¾ç»“æœã€‚</p>
<p>æ‰€ä»¥ç¬”è€…ç»™å‡ºçš„å»ºè®®æ˜¯</p>
<ul>
<li>åœ¨æ€§èƒ½è¦æ±‚é«˜çš„å…³é”®è·¯å¾„ä¸Šå°½é‡å°‘ä½¿ç”¨å¯¼èˆªå±æ€§</li>
<li>å°½é‡ä¸ä¾èµ–å®ä½“æ›´æ”¹è‡ªåŠ¨æ£€æµ‹</li>
</ul>
<p>å½“ç„¶äº†ï¼Œå¯¼èˆªå±æ€§è¿˜æ˜¯å¾ˆå¥½çš„ï¼Œç¼–å†™ <code>Where</code> çš„æ—¶å€™å¯ä»¥å°‘ç¼–å†™å¾ˆå¤š <code>Join</code>â€¦â€¦</p>
<p>ä»Šå¤©å…³äºæŸ¥è¯¢ç¼–è¯‘å’ŒæŸ¥è¯¢è·Ÿè¸ªçš„è®¨è®ºå°±åˆ°è¿™é‡Œå•¦ã€‚</p>

  <p></p>
  


          <div class="row mt-2">
  
    <div class="eight columns">
      <p id="madewith">
        <a class="footer-link" href="https://hexo.io" target="_blank" style="text-decoration: none;" rel="noreferrer" aria-label="Hexo.io">è‡ªè±ªåœ°é‡‡ç”¨Hexo<!--å’Œhttps://github.com/adisaktijrs/hexo-theme-minima/--></a>
        |
        <a class="footer-link" href="http://www.beian.miit.gov.cn/" target="_blank" style="text-decoration: none;" rel="noreferrer" aria-label="å·¥ä¿¡éƒ¨å¤‡æ¡ˆ">çš–ICPå¤‡17014812å·-1</a>
    </div>

    <!-- Sepcial thanks to https://simpleicons.org/ for the icons -->
    <div class="four columns mb-3 posisi" >
      
      <a class="ml-0 footer-link icon" href="https://github.com/yang-er" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="GitHub">
        <svg class="github svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
      </a>
      

      
      <a class="ml-0 footer-link icon" href="https://www.linkedin.com/in/%E8%89%AF%E6%AD%A3-%E6%9D%A8-0810451a4/" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="LinkedIn">
        <svg class="linkedin svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
      </a>
      

      

      
      <a class="ml-0 footer-link icon" id="mailuna" href="#" data-anuliam="tFWasR3b6kGQ5Fmbn1SZy5yYv1GI" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="Email">
        <svg class="mailru svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Mail</title><path d="M15.61 12c0 1.99-1.62 3.61-3.61 3.61-1.99 0-3.61-1.62-3.61-3.61 0-1.99 1.62-3.61 3.61-3.61 1.99 0 3.61 1.62 3.61 3.61M12 0C5.383 0 0 5.383 0 12s5.383 12 12 12c2.424 0 4.761-.722 6.76-2.087l.034-.024-1.617-1.879-.027.017A9.494 9.494 0 0 1 12 21.54c-5.26 0-9.54-4.28-9.54-9.54 0-5.26 4.28-9.54 9.54-9.54 5.26 0 9.54 4.28 9.54 9.54a9.63 9.63 0 0 1-.225 2.05c-.301 1.239-1.169 1.618-1.82 1.568-.654-.053-1.42-.52-1.426-1.661V12A6.076 6.076 0 0 0 12 5.93 6.076 6.076 0 0 0 5.93 12 6.076 6.076 0 0 0 12 18.07a6.02 6.02 0 0 0 4.3-1.792 3.9 3.9 0 0 0 3.32 1.805c.874 0 1.74-.292 2.437-.821.719-.547 1.256-1.336 1.553-2.285.047-.154.135-.504.135-.507l.002-.013c.175-.76.253-1.52.253-2.457 0-6.617-5.383-12-12-12"/></svg>
      </a>
      

    </div>
  
</div>

<script>
  (function () {
    const mailuna = document.getElementById('mailuna');
    const real = mailuna.attributes['data-anuliam'].value.split('').reverse().join('');
    mailuna.href = atob(real).split('').reverse().join('').trim();
  })();
</script>

        </div>
      </div>

    </div>

  </div>
  <script src="/js/nanobar.min.js"></script>
  <script>
    var options = {
      classname: 'nanobar',
      id: 'myNanobar'
    };
    var nanobar = new Nanobar(options);
    nanobar.go(30);
    nanobar.go(76);
    nanobar.go(100);
  </script>

</body>

</html>
